<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Lessons - Teacher Alex Academy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body class="sophisticated-bg min-h-screen">

    <!-- Fixed Header -->
    <div class="elegant-card sticky top-4 z-10 mx-4 rounded-lg mb-4">
        <div class="p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 logo-sophisticated rounded-full flex items-center justify-center">
                        <span class="text-white font-bold">A</span>
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold text-charcoal">Audio Lessons</h1>
                        <p class="text-sm text-medium-gray">A1 Foundation Course</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="portal.html" class="link-sophisticated text-sm">← Portal</a>
                    <button id="logoutBtn" class="link-muted text-sm">Sair</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto px-4 pb-8">
        
        <!-- Course Header -->
        <div class="elegant-card rounded-lg p-6 mb-6">
            <div class="text-center">
                <div class="text-5xl mb-4">🎧</div>
                <h2 class="text-2xl font-bold text-charcoal mb-2">A1 Foundation Course</h2>
                <p class="text-medium-gray mb-4">Complete English basics with 10 audio lessons</p>
                <div class="bg-powder-blue rounded-lg p-3">
                    <p class="text-alex-blue font-medium">Click any lesson to start learning!</p>
                </div>
            </div>
        </div>

        <!-- Firebase Status -->
        <div class="elegant-card rounded-lg p-4 mb-6 text-center">
            <div id="firebaseStatus" class="text-sm">
                <span class="text-alex-blue font-medium">🔥 Carregando progresso do Firebase...</span>
            </div>
        </div>

        <!-- Lessons Grid -->
        <div id="lessonsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Lessons will be loaded here with Firebase data -->
        </div>

        <!-- Audio System Info -->
        <div class="elegant-card rounded-lg p-6 mt-6 text-center">
            <div class="text-3xl mb-3">🎵</div>
            <h3 class="text-lg font-semibold text-charcoal mb-2">Audio System Ready!</h3>
            <p class="text-medium-gray mb-4">Real MP3 files loaded • Progress tracked in Firebase</p>
            <div class="bg-soft-blue rounded-lg p-3">
                <p class="text-alex-blue text-sm font-medium">All 10 lessons available with working audio players!</p>
            </div>
        </div>
    </div>

    <!-- Audio Player Modal -->
    <div id="audioModal" class="hidden fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="elegant-card rounded-2xl p-6 max-w-md w-full">
            <div class="text-center">
                <div class="text-4xl mb-4">🎧</div>
                <h3 id="modalTitle" class="text-xl font-bold text-charcoal mb-4">Audio Lesson</h3>
                
                <!-- Audio Player -->
                <audio id="audioPlayer" class="w-full mb-4" controls>
                    <source id="audioSource" src="" type="audio/mpeg">
                    Your browser does not support audio.
                </audio>
                
                <!-- Progress Info -->
                <div class="bg-powder-blue rounded-lg p-3 mb-4">
                    <p id="progressInfo" class="text-alex-blue text-sm font-medium">Loading lesson progress...</p>
                </div>
                
                <!-- Controls -->
                <div class="space-y-3">
                    <button id="markCompleted" class="btn-primary w-full py-3 rounded-lg font-semibold">
                        ✅ Mark as Completed (+100 XP)
                    </button>
                    <button id="closeAudio" class="btn-secondary w-full py-3 rounded-lg font-semibold">
                        Close Audio
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module" src="../js/firebase.js"></script>

    <!-- Lessons Logic with Firebase -->
    <script type="module">
        import { db } from '../js/firebase.js';
        import { doc, getDoc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js';

        // Lesson data
        const LESSONS = [
            { id: 'audio-01', title: 'Basic Greetings', description: 'Learn essential greeting phrases and introductions', duration: '35s', icon: '🌟' },
            { id: 'audio-02', title: 'Family Introduction', description: 'Learn to talk about family members and relationships', duration: '38s', icon: '👨‍👩‍👧‍👦' },
            { id: 'audio-03', title: 'Daily Routine', description: 'Learn to describe daily activities and time expressions', duration: '40s', icon: '⏰' },
            { id: 'audio-04', title: 'Food and Drinks', description: 'Learn vocabulary for food, drinks, and restaurants', duration: '36s', icon: '🍔' },
            { id: 'audio-05', title: 'Weather and Clothes', description: 'Learn to describe weather conditions and clothing', duration: '37s', icon: '☀️' },
            { id: 'audio-06', title: 'Shopping', description: 'Learn shopping vocabulary and store information', duration: '39s', icon: '🛒' },
            { id: 'audio-07', title: 'Hobbies and Free Time', description: 'Learn to talk about hobbies and leisure activities', duration: '35s', icon: '🎸' },
            { id: 'audio-08', title: 'Transportation', description: 'Learn about different ways to travel and get around', duration: '38s', icon: '🚌' },
            { id: 'audio-09', title: 'Health and Body', description: 'Learn vocabulary about health, exercise, and body care', duration: '40s', icon: '💪' },
            { id: 'audio-10', title: 'Future Plans', description: 'Learn to talk about future plans and aspirations', duration: '37s', icon: '🚀' }
        ];

        let currentLesson = null;
        let studentData = null;

        // Auth check
        function getCurrentStudent() {
            const authData = localStorage.getItem('studentAuth');
            return authData ? JSON.parse(authData) : null;
        }

        function checkAuth() {
            const auth = localStorage.getItem('studentLoggedIn');
            if (!auth) {
                window.location.href = '../index.html';
                return false;
            }
            return true;
        }

        // Load lessons with Firebase progress
        async function loadLessonsWithProgress() {
            try {
                const currentStudent = getCurrentStudent();
                if (!currentStudent) return;

                document.getElementById('firebaseStatus').innerHTML = '<span class="text-alex-blue font-medium">🔍 Carregando progresso...</span>';

                const studentRef = doc(db, 'students', currentStudent.username);
                const studentDoc = await getDoc(studentRef);
                
                if (studentDoc.exists()) {
                    studentData = studentDoc.data();
                    const audioLessons = studentData.audioLessons || {};
                    
                    renderLessons(audioLessons);
                    
                    const completedCount = Object.values(audioLessons).filter(lesson => lesson.status === 'completed').length;
                    document.getElementById('firebaseStatus').innerHTML = `<span class="text-green-600 font-medium">✅ Firebase conectado: ${completedCount}/10 aulas concluídas</span>`;
                } else {
                    document.getElementById('firebaseStatus').innerHTML = '<span class="text-red-600 font-medium">❌ Dados do estudante não encontrados</span>';
                    renderLessons({});
                }
            } catch (error) {
                console.error('❌ Error loading progress:', error);
                document.getElementById('firebaseStatus').innerHTML = '<span class="text-red-600 font-medium">❌ Erro Firebase - mostrando aulas disponíveis</span>';
                renderLessons({});
            }
        }

        function renderLessons(audioLessons) {
            const grid = document.getElementById('lessonsGrid');
            
            grid.innerHTML = LESSONS.map((lesson, index) => {
                const progress = audioLessons[lesson.id] || { status: 'not-started', score: 0, attempts: 0 };
                const statusClass = getStatusClass(progress.status);
                const statusText = getStatusText(progress.status);
                
                return `
                    <div class="lesson-card elegant-card rounded-lg p-4 cursor-pointer hover:scale-105 transition-all" onclick="startLesson('${lesson.id}')">
                        <div class="flex items-center justify-between mb-3">
                            <div class="text-2xl">${lesson.icon}</div>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <h3 class="font-semibold text-charcoal mb-2">Lesson ${index + 1}: ${lesson.title}</h3>
                        <p class="text-sm text-medium-gray mb-3">${lesson.description}</p>
                        <div class="flex items-center justify-between text-xs text-medium-gray">
                            <span>📞 ${lesson.duration}</span>
                            <span class="font-semibold text-alex-blue">${progress.status === 'completed' ? '✅ Done' : '+100 XP'}</span>
                        </div>
                        ${progress.attempts > 0 ? `
                            <div class="mt-2 text-xs text-medium-gray">
                                Tentativas: ${progress.attempts} • Score: ${progress.score || 0}/5
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function getStatusClass(status) {
            const classes = {
                'completed': 'status-completed',
                'in-progress': 'status-in-progress',
                'not-started': 'status-not-started'
            };
            return classes[status] || 'status-not-started';
        }

        function getStatusText(status) {
            const texts = {
                'completed': 'Completed',
                'in-progress': 'In Progress', 
                'not-started': 'Available'
            };
            return texts[status] || 'Available';
        }

        // Start lesson function
        window.startLesson = function(lessonId) {
            console.log('🎧 Starting lesson:', lessonId);
            
            currentLesson = LESSONS.find(l => l.id === lessonId);
            if (!currentLesson) return;

            // Show audio modal
            const modal = document.getElementById('audioModal');
            const title = document.getElementById('modalTitle');
            const source = document.getElementById('audioSource');
            const player = document.getElementById('audioPlayer');
            const progressInfo = document.getElementById('progressInfo');
            
            title.textContent = `${currentLesson.title}`;
            
            // Set audio source - using your actual file structure
            const audioFilename = lessonId === 'audio-01' ? 'audio-01-greetings.mp3' :
                                 lessonId === 'audio-02' ? 'audio-02-family.mp3' :
                                 lessonId === 'audio-03' ? 'audio-03-routine.mp3' :
                                 lessonId === 'audio-04' ? 'audio-04-food.mp3' :
                                 lessonId === 'audio-05' ? 'audio-05-weather.mp3' :
                                 lessonId === 'audio-06' ? 'audio-06-shopping.mp3' :
                                 lessonId === 'audio-07' ? 'audio-07-hobbies.mp3' :
                                 lessonId === 'audio-08' ? 'audio-08-transportation.mp3' :
                                 lessonId === 'audio-09' ? 'audio-09-health.mp3' :
                                 'audio-10-future.mp3';
            
            source.src = `../audio/a1-foundation/${audioFilename}`;
            player.load();
            
            // Show progress info
            if (studentData && studentData.audioLessons && studentData.audioLessons[lessonId]) {
                const progress = studentData.audioLessons[lessonId];
                progressInfo.textContent = `Status: ${progress.status} • Tentativas: ${progress.attempts}`;
            } else {
                progressInfo.textContent = 'Primeira vez nesta aula - boa sorte!';
            }
            
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };

        // Mark lesson as completed
        async function markLessonCompleted() {
            if (!currentLesson) return;

            try {
                const currentStudent = getCurrentStudent();
                if (!currentStudent) return;

                const studentRef = doc(db, 'students', currentStudent.username);
                const lessonPath = `audioLessons.${currentLesson.id}`;
                
                const updateData = {
                    [lessonPath]: {
                        status: 'completed',
                        score: 5, // Perfect score for now
                        attempts: 1,
                        completedAt: serverTimestamp(),
                        timeSpent: 60 // Estimated
                    },
                    totalXP: (studentData?.totalXP || 0) + 100,
                    completedLessons: (studentData?.completedLessons || 0) + 1,
                    lastLogin: serverTimestamp()
                };

                await updateDoc(studentRef, updateData);
                
                // Update local data
                if (!studentData.audioLessons) studentData.audioLessons = {};
                studentData.audioLessons[currentLesson.id] = updateData[lessonPath];
                studentData.totalXP = updateData.totalXP;
                
                document.getElementById('progressInfo').textContent = '✅ Aula marcada como concluída! +100 XP';
                
                // Reload lessons to show updated progress
                setTimeout(() => {
                    closeAudioModal();
                    loadLessonsWithProgress();
                }, 1500);
                
                console.log('✅ Lesson completed and saved to Firebase');
                
            } catch (error) {
                console.error('❌ Error marking lesson completed:', error);
                document.getElementById('progressInfo').textContent = '❌ Erro ao salvar progresso no Firebase';
            }
        }

        function closeAudioModal() {
            const modal = document.getElementById('audioModal');
            const player = document.getElementById('audioPlayer');
            
            player.pause();
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            currentLesson = null;
        }

        // Event listeners
        document.getElementById('markCompleted').addEventListener('click', markLessonCompleted);
        document.getElementById('closeAudio').addEventListener('click', closeAudioModal);

        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('studentLoggedIn');
            localStorage.removeItem('studentUsername');
            localStorage.removeItem('studentAuth');
            window.location.href = '../index.html';
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🎧 Audio Lessons com Firebase carregando...');
            
            if (!checkAuth()) return;
            
            loadLessonsWithProgress();
            console.log('✅ Audio Lessons com Firebase pronto!');
        });
    </script>

</body>
</html>
