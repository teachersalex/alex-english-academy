<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Lessons - Teacher Alex Academy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body class="sophisticated-bg min-h-screen">

    <!-- Fixed Header -->
    <div class="bg-smoke-white border-b border-light-gray sticky top-0 z-10"
         style="background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
        <div class="max-w-sm mx-auto px-3 sm:max-w-md md:max-w-lg lg:max-w-2xl xl:max-w-4xl sm:px-4 md:px-6 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 sm:w-10 sm:h-10 logo-sophisticated rounded-full flex items-center justify-center">
                        <span class="text-white font-bold text-sm sm:text-base">A</span>
                    </div>
                    <div>
                        <h1 class="text-sm sm:text-base md:text-lg font-semibold text-charcoal">Audio Lessons</h1>
                        <p class="text-xs sm:text-sm text-medium-gray" id="lessonProgress">Lesson 1 of 10</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <a href="portal.html" class="text-xs sm:text-sm link-muted hover:text-charcoal transition-colors">
                        ‚Üê Portal
                    </a>
                    <button id="logoutBtn" class="text-xs sm:text-sm link-muted hover:text-charcoal transition-colors">
                        Sair
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-sm mx-auto px-3 sm:max-w-md md:max-w-lg lg:max-w-2xl xl:max-w-4xl sm:px-4 md:px-6 py-3 sm:py-4 md:py-6">
        
        <!-- Lesson Selection -->
        <div id="lessonSelection" class="elegant-card rounded-lg p-3 sm:p-4 md:p-6 mb-4 sm:mb-5 md:mb-6">
            <h2 class="text-base sm:text-lg md:text-xl font-semibold mb-3 sm:mb-4 md:mb-6 text-charcoal">üéß A1 Foundation Course</h2>
            
            <div id="lessonGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                <!-- Lessons will be loaded here -->
            </div>
        </div>

        <!-- Audio Lesson Interface -->
        <div id="lessonInterface" class="hidden">
            
            <!-- Lesson Header -->
            <div class="lesson-card mb-4 sm:mb-5 md:mb-6">
                <div class="lesson-header">
                    <h2 id="lessonTitle" class="text-xl sm:text-2xl md:text-3xl font-bold mb-2">Basic Greetings</h2>
                    <p id="lessonDescription" class="text-sm sm:text-base opacity-90 mb-4">Learn essential greeting phrases and introductions</p>
                    
                    <div class="lesson-progress-indicator">
                        <div class="flex justify-between text-sm mb-2">
                            <span>Lesson Progress</span>
                            <span id="lessonProgressText">Not Started</span>
                        </div>
                        <div class="progress-bar-container">
                            <div id="lessonProgressBar" class="progress-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Audio Player -->
                <div class="audio-player-container">
                    <div class="text-center mb-4">
                        <div class="text-lg sm:text-xl font-semibold text-charcoal mb-2">üéß Listen to the Audio</div>
                        <p class="text-sm text-medium-gray">Listen carefully and then answer the questions below</p>
                    </div>
                    
                    <audio id="audioPlayer" class="w-full mb-4" controls>
                        <source id="audioSource" src="" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>
                    
                    <!-- Audio Controls -->
                    <div class="audio-controls">
                        <button id="playPauseBtn" class="audio-control-btn play-btn">
                            ‚ñ∂Ô∏è
                        </button>
                        <button id="rewindBtn" class="audio-control-btn">
                            ‚è™
                        </button>
                        <button id="forwardBtn" class="audio-control-btn">
                            ‚è©
                        </button>
                    </div>
                    
                    <!-- Speed Controls -->
                    <div class="speed-controls">
                        <button class="speed-btn" data-speed="0.5">0.5x</button>
                        <button class="speed-btn" data-speed="0.75">0.75x</button>
                        <button class="speed-btn active" data-speed="1">1x</button>
                        <button class="speed-btn" data-speed="1.25">1.25x</button>
                        <button class="speed-btn" data-speed="1.5">1.5x</button>
                    </div>
                </div>
            </div>

            <!-- Questions Section -->
            <div id="questionsSection" class="space-y-4 sm:space-y-5 md:space-y-6">
                <!-- Questions will be loaded here -->
            </div>

            <!-- Navigation -->
            <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 mt-6">
                <button id="prevLessonBtn" class="btn-subtle w-full sm:w-auto px-6 py-3 rounded-lg font-medium">
                    ‚Üê Previous Lesson
                </button>
                <button id="submitAnswersBtn" class="btn-primary w-full sm:flex-1 py-3 rounded-lg font-semibold">
                    Submit Answers
                </button>
                <button id="nextLessonBtn" class="btn-secondary w-full sm:w-auto px-6 py-3 rounded-lg font-medium">
                    Next Lesson ‚Üí
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="elegant-card rounded-2xl p-6 text-center">
            <div class="text-4xl mb-4">üéß</div>
            <div class="text-lg font-semibold text-charcoal mb-2">Loading Lesson...</div>
            <div class="text-medium-gray">Please wait while we prepare your audio lesson</div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { getCurrentStudent } from '../js/auth.js';
        import { 
            loadLessonProgress, 
            saveLessonProgress, 
            completeLessonWithXP, 
            startLesson,
            getStudentOverallProgress 
        } from '../js/progress-sync.js';
        import { 
            checkAchievements, 
            showAchievementPopup, 
            showLessonResults, 
            showAnswerReview 
        } from '../js/achievement-system.js';
        import { 
            getAllLessons, 
            getLessonById, 
            getNextLesson, 
            getPreviousLesson 
        } from '../js/lesson-data.js';

        // ================================================================
        // GLOBAL STATE
        // ================================================================
        
        let currentLesson = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let lessonStartTime = null;
        let audioPlayer = null;
        let allLessons = [];

        // ================================================================
        // INITIALIZATION
        // ================================================================

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üéß Audio Lessons Interface Loading...');
            
            // Check authentication
            const currentStudent = getCurrentStudent();
            if (!currentStudent) {
                window.location.href = '../index.html';
                return;
            }

            // Initialize components
            initializeAudioPlayer();
            initializeEventListeners();
            
            // Load lessons and check URL parameters
            allLessons = getAllLessons();
            const urlParams = new URLSearchParams(window.location.search);
            const lessonId = urlParams.get('lesson');
            
            if (lessonId) {
                await loadLesson(lessonId);
            } else {
                await loadLessonSelection();
            }
            
            console.log('‚úÖ Audio Lessons Interface Ready!');
        });

        // ================================================================
        // LESSON SELECTION
        // ================================================================

        async function loadLessonSelection() {
            document.getElementById('lessonSelection').classList.remove('hidden');
            document.getElementById('lessonInterface').classList.add('hidden');
            
            const lessonGrid = document.getElementById('lessonGrid');
            const progressData = await getStudentOverallProgress();
            const studentLessons = progressData.success ? progressData.audioLessons : {};
            
            lessonGrid.innerHTML = allLessons.map(lesson => {
                const progress = studentLessons[lesson.id] || { status: 'not-started' };
                const statusClass = getStatusClass(progress.status);
                const statusIcon = getStatusIcon(progress.status);
                const score = progress.score && progress.totalQuestions ? 
                    `${Math.round((progress.score / progress.totalQuestions) * 100)}%` : '';
                
                return `
                    <div class="lesson-card p-4 cursor-pointer transition-all hover:scale-105"
                         onclick="loadLesson('${lesson.id}')">
                        <div class="flex items-center justify-between mb-3">
                            <div class="text-2xl">${statusIcon}</div>
                            <span class="status-badge ${statusClass}">${getStatusText(progress.status)}</span>
                        </div>
                        <h3 class="font-semibold text-charcoal mb-1">${lesson.title}</h3>
                        <p class="text-sm text-medium-gray mb-3">${lesson.description}</p>
                        <div class="flex items-center justify-between text-xs text-medium-gray">
                            <span>${lesson.duration}s</span>
                            ${score ? `<span class="font-semibold text-alex-blue">${score}</span>` : ''}
                        </div>
                        ${progress.status === 'in-progress' ? `
                            <div class="mt-2">
                                <div class="progress-bar-container h-1">
                                    <div class="progress-bar" style="width: ${(progress.currentQuestionIndex || 0) * 20}%;"></div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function getStatusClass(status) {
            const classes = {
                'completed': 'status-completed',
                'in-progress': 'status-in-progress',
                'not-started': 'status-not-started'
            };
            return classes[status] || 'status-not-started';
        }

        function getStatusIcon(status) {
            const icons = {
                'completed': '‚úÖ',
                'in-progress': 'üìù',
                'not-started': 'üîí'
            };
            return icons[status] || 'üîí';
        }

        function getStatusText(status) {
            const texts = {
                'completed': 'Completed',
                'in-progress': 'In Progress', 
                'not-started': 'Not Started'
            };
            return texts[status] || 'Not Started';
        }

        // ================================================================
        // LESSON LOADING
        // ================================================================

        async function loadLesson(lessonId) {
            try {
                showLoading(true);
                
                // Get lesson data
                currentLesson = getLessonById(lessonId);
                if (!currentLesson) {
                    throw new Error('Lesson not found');
                }

                // Load progress
                const progressResult = await loadLessonProgress(lessonId);
                const progress = progressResult.progress;

                // Start lesson session
                await startLesson(lessonId);
                lessonStartTime = Date.now();

                // Update UI
                updateLessonHeader();
                setupAudioPlayer();
                loadQuestions();
                updateNavigation();
                
                // Show lesson interface
                document.getElementById('lessonSelection').classList.add('hidden');
                document.getElementById('lessonInterface').classList.remove('hidden');
                
                // Update URL
                window.history.pushState({}, '', `?lesson=${lessonId}`);
                
                console.log(`üéØ Lesson ${lessonId} loaded successfully`);
                
            } catch (error) {
                console.error('‚ùå Error loading lesson:', error);
                alert('Error loading lesson. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        function updateLessonHeader() {
            const lessonNumber = currentLesson.order;
            const totalLessons = allLessons.length;
            
            document.getElementById('lessonTitle').textContent = currentLesson.title;
            document.getElementById('lessonDescription').textContent = currentLesson.description;
            document.getElementById('lessonProgress').textContent = `Lesson ${lessonNumber} of ${totalLessons}`;
            
            // Reset progress
            document.getElementById('lessonProgressText').textContent = 'Listening';
            document.getElementById('lessonProgressBar').style.width = '20%';
        }

        function setupAudioPlayer() {
            const audioSource = document.getElementById('audioSource');
            audioSource.src = currentLesson.audioPath;
            audioPlayer.load();
            
            // Reset player state
            document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è';
            document.querySelector('.speed-btn.active').classList.remove('active');
            document.querySelector('[data-speed="1"]').classList.add('active');
            audioPlayer.playbackRate = 1;
        }

        function loadQuestions() {
            const questionsSection = document.getElementById('questionsSection');
            userAnswers = new Array(currentLesson.questions.length).fill(null);
            currentQuestionIndex = 0;
            
            questionsSection.innerHTML = currentLesson.questions.map((question, index) => `
                <div class="question-container" data-question="${index}">
                    <div class="question-header">
                        <div class="question-number">${index + 1}</div>
                        <div class="flex-1 ml-3">
                            <div class="text-sm text-medium-gray">Question ${index + 1} of ${currentLesson.questions.length}</div>
                        </div>
                    </div>
                    
                    <div class="question-text">${question.question}</div>
                    
                    <div class="answer-options">
                        ${question.options.map((option, optionIndex) => `
                            <div class="answer-option" 
                                 data-question="${index}" 
                                 data-option="${optionIndex}"
                                 onclick="selectAnswer(${index}, ${optionIndex})">
                                <div class="option-letter">${String.fromCharCode(65 + optionIndex)}</div>
                                <div class="flex-1">${option}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // ================================================================
        // AUDIO PLAYER CONTROL
        // ================================================================

        function initializeAudioPlayer() {
            audioPlayer = document.getElementById('audioPlayer');
            
            // Audio event listeners
            audioPlayer.addEventListener('play', () => {
                document.getElementById('playPauseBtn').textContent = '‚è∏Ô∏è';
            });
            
            audioPlayer.addEventListener('pause', () => {
                document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è';
            });
            
            audioPlayer.addEventListener('ended', () => {
                document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è';
                document.getElementById('lessonProgressText').textContent = 'Ready for Questions';
                document.getElementById('lessonProgressBar').style.width = '40%';
            });
            
            audioPlayer.addEventListener('timeupdate', () => {
                if (audioPlayer.duration) {
                    const progress = 20 + (audioPlayer.currentTime / audioPlayer.duration) * 20; // 20-40%
                    document.getElementById('lessonProgressBar').style.width = `${progress}%`;
                }
            });
        }

        function initializeEventListeners() {
            // Audio controls
            document.getElementById('playPauseBtn').addEventListener('click', () => {
                if (audioPlayer.paused) {
                    audioPlayer.play();
                } else {
                    audioPlayer.pause();
                }
            });
            
            document.getElementById('rewindBtn').addEventListener('click', () => {
                audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 10);
            });
            
            document.getElementById('forwardBtn').addEventListener('click', () => {
                audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 10);
            });
            
            // Speed controls
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const speed = parseFloat(btn.dataset.speed);
                    audioPlayer.playbackRate = speed;
                    
                    document.querySelector('.speed-btn.active').classList.remove('active');
                    btn.classList.add('active');
                });
            });
            
            // Navigation
            document.getElementById('submitAnswersBtn').addEventListener('click', submitAnswers);
            document.getElementById('prevLessonBtn').addEventListener('click', goToPreviousLesson);
            document.getElementById('nextLessonBtn').addEventListener('click', goToNextLesson);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        }

        // ================================================================
        // QUESTION HANDLING
        // ================================================================

        window.selectAnswer = function(questionIndex, optionIndex) {
            // Remove previous selection
            document.querySelectorAll(`[data-question="${questionIndex}"]`).forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add new selection
            document.querySelector(`[data-question="${questionIndex}"][data-option="${optionIndex}"]`)
                .classList.add('selected');
            
            // Store answer
            userAnswers[questionIndex] = optionIndex;
            
            // Update progress
            const answeredCount = userAnswers.filter(answer => answer !== null).length;
            const progress = 40 + (answeredCount / currentLesson.questions.length) * 60; // 40-100%
            document.getElementById('lessonProgressBar').style.width = `${progress}%`;
            document.getElementById('lessonProgressText').textContent = 
                `${answeredCount}/${currentLesson.questions.length} Questions Answered`;
            
            // Enable submit if all answered
            if (answeredCount === currentLesson.questions.length) {
                document.getElementById('submitAnswersBtn').disabled = false;
                document.getElementById('submitAnswersBtn').classList.remove('opacity-50');
            }
        };

        async function submitAnswers() {
            try {
                // Validate all questions answered
                const unansweredCount = userAnswers.filter(answer => answer === null).length;
                if (unansweredCount > 0) {
                    alert(`Please answer all questions. ${unansweredCount} questions remaining.`);
                    return;
                }
                
                showLoading(true);
                
                // Calculate score
                const correctAnswers = currentLesson.questions.map(q => q.correct);
                const score = userAnswers.reduce((total, answer, index) => {
                    return total + (answer === correctAnswers[index] ? 1 : 0);
                }, 0);
                
                // Calculate time spent
                const timeSpent = Math.floor((Date.now() - lessonStartTime) / 1000);
                
                // Complete lesson and get XP
                const result = await completeLessonWithXP(
                    currentLesson.id,
                    score,
                    currentLesson.questions.length,
                    timeSpent,
                    userAnswers,
                    correctAnswers
                );
                
                if (result.success) {
                    // Check for achievements
                    const achievementResult = await checkAchievements({
                        score,
                        totalQuestions: currentLesson.questions.length,
                        xpEarned: result.xpEarned
                    });
                    
                    // Show results
                    showLessonResults({
                        score,
                        totalQuestions: currentLesson.questions.length,
                        xpEarned: result.xpEarned
                    }, achievementResult.newAchievements, (action) => {
                        if (action === 'review') {
                            showAnswerReview({
                                answers: userAnswers,
                                correctAnswers: correctAnswers
                            }, currentLesson.questions);
                        } else if (action === 'continue') {
                            goToNextLesson();
                        }
                    });
                    
                    // Show achievement popups
                    if (achievementResult.newAchievements.length > 0) {
                        setTimeout(() => {
                            achievementResult.newAchievements.forEach((achievement, index) => {
                                setTimeout(() => {
                                    showAchievementPopup(achievement);
                                }, index * 1000);
                            });
                        }, 2000);
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Error submitting answers:', error);
                alert('Error submitting answers. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        // ================================================================
        // NAVIGATION
        // ================================================================

        function updateNavigation() {
            const prevLesson = getPreviousLesson(currentLesson.id);
            const nextLesson = getNextLesson(currentLesson.id);
            
            const prevBtn = document.getElementById('prevLessonBtn');
            const nextBtn = document.getElementById('nextLessonBtn');
            
            if (prevLesson) {
                prevBtn.textContent = `‚Üê ${prevLesson.title}`;
                prevBtn.disabled = false;
                prevBtn.classList.remove('opacity-50');
            } else {
                prevBtn.textContent = '‚Üê Previous Lesson';
                prevBtn.disabled = true;
                prevBtn.classList.add('opacity-50');
            }
            
            if (nextLesson) {
                nextBtn.textContent = `${nextLesson.title} ‚Üí`;
                nextBtn.disabled = false;
                nextBtn.classList.remove('opacity-50');
            } else {
                nextBtn.textContent = 'Course Complete! ‚Üí';
                nextBtn.disabled = false;
                nextBtn.classList.remove('opacity-50');
            }
        }

        async function goToPreviousLesson() {
            const prevLesson = getPreviousLesson(currentLesson.id);
            if (prevLesson) {
                await loadLesson(prevLesson.id);
            }
        }

        async function goToNextLesson() {
            const nextLesson = getNextLesson(currentLesson.id);
            if (nextLesson) {
                await loadLesson(nextLesson.id);
            } else {
                // Course completed - return to portal
                window.location.href = 'portal.html';
            }
        }

        // ================================================================
        // UTILITY FUNCTIONS
        // ================================================================

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function handleLogout() {
            localStorage.removeItem('studentLoggedIn');
            localStorage.removeItem('studentUsername');
            localStorage.removeItem('studentAuth');
            window.location.href = '../index.html';
        }

        // ================================================================
        // GLOBAL FUNCTIONS
        // ================================================================

        window.loadLesson = loadLesson;
        
        console.log('üéß Audio Lessons System Ready!');
    </script>

</body>
</html>