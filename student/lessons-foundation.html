<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A1 Foundation - Teacher Alex Academy</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body class="sophisticated-bg">

    <!-- Professional Header Bar -->
    <header class="fixed w-full top-0 left-0 right-0 bg-primary z-50">
        <div class="header-container">
            <div class="header-left">
                <div class="brand-line">Teacher Alex English Academy</div>
                <div class="user-course-line" id="userCourseLine">Alex12345 ‚Ä¢ A1 Foundation Course</div>
            </div>
            
            <div class="header-actions">
                <button class="btn-portal" onclick="window.location.href='hub.html'">‚Üê Hub</button>
                <button class="btn-logout" onclick="logout()">Sair</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="lesson-container">
        <div class="content-wrapper">
        
        <!-- Lesson Selection View -->
        <div id="lessonSelection" class="fade-in">
            <!-- Course Header -->
            <div class="elegant-card lesson-header mb-6">
                <div class="text-center">
                    <div class="course-icon mb-4">üåü</div>
                    <h2 class="heading-primary mb-2">A1 Foundation Course</h2>
                    <p class="text-muted mb-4">Complete English basics with 10 interactive audio lessons</p>
                    <div class="glass-card rounded-lg p-3">
                        <p class="course-features">üéØ Complete questions ‚Ä¢ üìä Track progress ‚Ä¢ üèÜ Earn XP & achievements!</p>
                    </div>
                </div>
            </div>

            <!-- Firebase Status -->
            <div class="stats-card rounded-lg p-4 mb-6 text-center">
                <div id="firebaseStatus" class="text-sm">
                    <span class="text-alex-blue font-medium">üî• Carregando progresso do Firebase...</span>
                </div>
            </div>

            <!-- Lessons Grid -->
            <div id="lessonsGrid" class="lessons-grid">
                <!-- Lessons will be loaded here -->
            </div>
        </div>

        <!-- Interactive Lesson View -->
        <div id="lessonInterface" class="hidden">
            <!-- Lesson Header -->
            <div class="elegant-card rounded-xl p-6 mb-6 slide-up">
                <div class="lesson-nav mb-4">
                    <button id="backToLessons" class="link-sophisticated text-sm">‚Üê Back to Foundation</button>
                    <div id="lessonProgress" class="text-muted">Lesson 1 of 10</div>
                </div>
                
                <h2 id="lessonTitle" class="heading-secondary mb-2">Basic Greetings</h2>
                <p id="lessonDescription" class="text-muted mb-4">Learn essential greeting phrases and introductions</p>
                
                <!-- Enhanced Progress Indicator -->
                <div class="progress-container">
                    <div class="progress-header mb-2">
                        <span>Lesson Progress</span>
                        <span id="progressText">Listen to Audio</span>
                    </div>
                    <div class="progress-bar-container">
                        <div id="progressBar" class="progress-bar"></div>
                    </div>
                </div>
            </div>

            <!-- Audio Player -->
            <div class="audio-player-container mb-6 slide-up">
                <div class="text-center mb-4">
                    <h3 class="heading-secondary mb-2">üéß Listen to the Audio</h3>
                    <p class="text-muted">Listen carefully and answer the questions below</p>
                </div>
                
                <audio id="audioPlayer" class="audio-enhanced w-full mb-4" controls>
                    <source id="audioSource" src="" type="audio/mpeg">
                    Your browser does not support audio.
                </audio>
                
                <!-- Audio Controls -->
                <div class="audio-controls mb-4">
                    <button id="playPauseBtn" class="btn-secondary audio-control-btn play-btn">‚ñ∂Ô∏è Play</button>
                    <button id="rewindBtn" class="btn-subtle audio-control-btn">‚è™ -10s</button>
                    <button id="forwardBtn" class="btn-subtle audio-control-btn">‚è© +10s</button>
                </div>
                
                <!-- Speed Controls -->
                <div class="speed-controls">
                    <button class="speed-btn active" data-speed="0.75">0.75x</button>
                    <button class="speed-btn active" data-speed="1">1x</button>
                    <button class="speed-btn" data-speed="1.25">1.25x</button>
                </div>
            </div>

            <!-- Questions Section -->
            <div id="questionsSection" class="questions-container mb-6">
                <!-- Questions will be loaded here -->
            </div>

            <!-- Submit Section -->
            <div class="elegant-card rounded-xl p-6 text-center slide-up">
                <button id="submitAnswers" class="btn-primary submit-btn" disabled>
                    Submit Answers (0/5 Complete)
                </button>
                <p class="text-muted text-sm mt-2">Answer all questions to continue</p>
            </div>
        </div>
        </div>
    </main>

    <!-- Results Modal -->
    <div id="resultsModal" class="modal-overlay hidden">
        <div class="modal-content results-modal">
            <div class="text-center">
                <div id="resultIcon" class="result-icon mb-4">üéâ</div>
                <h3 id="resultTitle" class="heading-primary mb-4">Lesson Complete!</h3>
                
                <!-- Score Display -->
                <div class="results-score mb-4">
                    <div id="scoreDisplay" class="score-display mb-1">5/5</div>
                    <div id="percentageDisplay" class="percentage-display mb-2">100% Correct</div>
                    <div id="xpEarned" class="xp-display">+75 XP Earned!</div>
                </div>
                
                <!-- Achievement -->
                <div id="achievementDisplay" class="hidden results-achievements mb-4">
                    <div class="achievement-header mb-2">üéâ Achievement Unlocked!</div>
                    <div id="achievementText" class="font-medium"></div>
                </div>
                
                <!-- Controls -->
                <div class="modal-actions">
                    <button id="reviewAnswers" class="btn-secondary w-full py-3 mb-3">
                        üìä Review Answers
                    </button>
                    <button id="tryAgainBtn" class="btn-subtle w-full py-3 mb-3 hidden">
                        üîÑ Tentar Novamente
                    </button>
                    <button id="nextLesson" class="btn-primary w-full py-3 mb-3">
                        Next Lesson ‚Üí
                    </button>
                    <button id="backToLessonsList" class="link-muted text-sm py-2">
                        Back to Foundation
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Answer Review Modal -->
    <div id="reviewModal" class="modal-overlay hidden">
        <div class="modal-content review-modal">
            <h3 class="heading-primary mb-4 text-center">üìù Answer Review</h3>
            <div id="reviewContent" class="review-content mb-6">
                <!-- Review content here -->
            </div>
            <button id="closeReview" class="btn-primary w-full py-3">
                Close Review
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module" src="../js/firebase.js"></script>

    <!-- Complete Interactive Lesson System -->
    <script type="module">
        import { db } from '../js/firebase.js';
        import { doc, getDoc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js';

        // Complete lesson data with ALL 10 Foundation lessons
        const LESSONS = [
            {
                id: 'audio-01',
                title: 'Basic Greetings',
                description: 'Learn essential greeting phrases and introductions',
                duration: '35s',
                icon: 'üåü',
                audioFile: 'audio-01-greetings.mp3',
                questions: [
                    {
                        question: "What is the woman's name?",
                        options: ["Sara", "Sarah", "Sandra", "Samantha"],
                        correct: 1
                    },
                    {
                        question: "Where is she from?",
                        options: ["Brazil", "USA", "Canada", "Mexico"],
                        correct: 2
                    },
                    {
                        question: "What is her job?",
                        options: ["Teacher", "Nurse", "Doctor", "Engineer"],
                        correct: 1
                    },
                    {
                        question: "How old is she?",
                        options: ["23", "24", "25", "26"],
                        correct: 2
                    },
                    {
                        question: "What does she say at the end?",
                        options: ["Goodbye", "See you later", "Have a great day", "Take care"],
                        correct: 2
                    }
                ]
            },
            {
                id: 'audio-02', 
                title: 'Family Introduction',
                description: 'Learn to talk about family members and relationships',
                duration: '38s',
                icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
                audioFile: 'audio-02-family.mp3',
                questions: [
                    {
                        question: "How many people are in the family?",
                        options: ["3", "4", "5", "6"],
                        correct: 1
                    },
                    {
                        question: "What does the mother like?",
                        options: ["Reading", "Cooking", "Dancing", "Shopping"],
                        correct: 1
                    },
                    {
                        question: "How old is the sister?",
                        options: ["18", "20", "22", "25"],
                        correct: 1
                    },
                    {
                        question: "Where does the father work?",
                        options: ["Hospital", "School", "Bank", "Restaurant"],
                        correct: 2
                    },
                    {
                        question: "Where do they live?",
                        options: ["Small apartment", "Big house", "Small house", "Big apartment"],
                        correct: 1
                    }
                ]
            },
            {
                id: 'audio-03',
                title: 'Daily Routine', 
                description: 'Learn to describe daily activities and time expressions',
                duration: '40s',
                icon: '‚è∞',
                audioFile: 'audio-03-routine.mp3',
                questions: [
                    {
                        question: "What time does she wake up?",
                        options: ["6 o'clock", "7 o'clock", "8 o'clock", "9 o'clock"],
                        correct: 1
                    },
                    {
                        question: "How does she go to work?",
                        options: ["By car", "By bus", "Walking", "By bike"],
                        correct: 1
                    },
                    {
                        question: "What time does she go to bed?",
                        options: ["9 o'clock", "10 o'clock", "11 o'clock", "12 o'clock"],
                        correct: 1
                    },
                    {
                        question: "What does she eat for breakfast?",
                        options: ["Cereal", "Eggs", "Bread with butter", "Fruit"],
                        correct: 2
                    },
                    {
                        question: "What time does she start work?",
                        options: ["8 o'clock", "9 o'clock", "8:30", "9:30"],
                        correct: 1
                    }
                ]
            },
            {
                id: 'audio-04',
                title: 'Food and Drinks',
                description: 'Learn vocabulary for food, drinks, and restaurant experiences',
                duration: '36s',
                icon: 'üçî',
                audioFile: 'audio-04-food.mp3', 
                questions: [
                    {
                        question: "What is her favorite drink?",
                        options: ["Coffee", "Tea", "Orange juice", "Water"],
                        correct: 2
                    },
                    {
                        question: "What dessert does she want?",
                        options: ["Ice cream", "Chocolate cake", "Apple pie", "Cookies"],
                        correct: 1
                    },
                    {
                        question: "When does she come to the restaurant?",
                        options: ["Every day", "Every weekend", "Every month", "Every week"],
                        correct: 1
                    },
                    {
                        question: "What food does she like?",
                        options: ["Pizza only", "Hamburgers only", "Pizza and hamburgers", "Salad"],
                        correct: 2
                    },
                    {
                        question: "How is the food at the restaurant?",
                        options: ["Expensive", "Delicious", "Bad", "Cold"],
                        correct: 1
                    }
                ]
            },
            {
                id: 'audio-05',
                title: 'Weather and Clothes',
                description: 'Learn to describe weather conditions and clothing',
                duration: '37s',
                icon: '‚òÄÔ∏è',
                audioFile: 'audio-05-weather.mp3',
                questions: [
                    {
                        question: "What is the weather like today?",
                        options: ["Cold and rainy", "Sunny and warm", "Cloudy", "Windy"],
                        correct: 1
                    },
                    {
                        question: "What did she wear yesterday?",
                        options: ["T-shirt and shorts", "Jacket and boots", "Jeans and sweater", "Dress"],
                        correct: 1
                    },
                    {
                        question: "Why does she love summer?",
                        options: ["No school", "Nice weather", "Long days", "Vacation time"],
                        correct: 1
                    },
                    {
                        question: "What is she wearing today?",
                        options: ["Jacket and boots", "Blue t-shirt and white shorts", "Jeans and sweater", "Black pants"],
                        correct: 1
                    },
                    {
                        question: "What will tomorrow's weather be like?",
                        options: ["Sunny", "Rainy", "Cloudy", "Hot"],
                        correct: 2
                    }
                ]
            },
            {
                id: 'audio-06',
                title: 'Shopping',
                description: 'Learn shopping vocabulary and store information',
                duration: '39s',
                icon: 'üõí',
                audioFile: 'audio-06-shopping.mp3',
                questions: [
                    {
                        question: "What fruits does she want to buy?",
                        options: ["Apples and oranges only", "Bananas only", "Apples, bananas, and oranges", "Only oranges"],
                        correct: 2
                    },
                    {
                        question: "When does the supermarket close?",
                        options: ["9 at night", "10 at night", "11 at night", "8 at night"],
                        correct: 1
                    },
                    {
                        question: "How does she pay?",
                        options: ["Cash", "Credit card", "Check", "Debit card"],
                        correct: 1
                    },
                    {
                        question: "What other things does she need to buy?",
                        options: ["Milk and eggs", "Bread only", "Milk, eggs, and bread", "Just milk"],
                        correct: 2
                    },
                    {
                        question: "How long does shopping take?",
                        options: ["20 minutes", "30 minutes", "40 minutes", "1 hour"],
                        correct: 1
                    }
                ]
            },
            {
                id: 'audio-07',
                title: 'Hobbies and Free Time',
                description: 'Learn to talk about hobbies and leisure activities',
                duration: '35s',
                icon: 'üé∏',
                audioFile: 'audio-07-hobbies.mp3',
                questions: [
                    {
                        question: "What instrument does she play?",
                        options: ["Piano", "Guitar", "Drums", "Violin"],
                        correct: 1
                    },
                    {
                        question: "When does she play this instrument?",
                        options: ["Every day", "Weekdays", "Weekends", "Sometimes"],
                        correct: 2
                    },
                    {
                        question: "What is her favorite hobby?",
                        options: ["Reading", "Photography", "Singing", "Dancing"],
                        correct: 1
                    },
                    {
                        question: "What does she not like doing?",
                        options: ["Singing", "Dancing", "Reading", "Playing guitar"],
                        correct: 1
                    },
                    {
                        question: "What does she take pictures of?",
                        options: ["People", "Buildings", "Nature and animals", "Cars"],
                        correct: 2
                    }
                ]
            },
            {
                id: 'audio-08',
                title: 'Transportation',
                description: 'Learn about different ways to travel and get around',
                duration: '38s',
                icon: 'üöå',
                audioFile: 'audio-08-transportation.mp3',
                questions: [
                    {
                        question: "How does she usually go to work?",
                        options: ["By car", "Walking", "By bus", "By bike"],
                        correct: 1
                    },
                    {
                        question: "When does she drive her car?",
                        options: ["Every day", "When it rains", "On weekends", "Never"],
                        correct: 2
                    },
                    {
                        question: "Why doesn't she like the subway?",
                        options: ["Too expensive", "Too crowded", "Too slow", "Too far"],
                        correct: 1
                    },
                    {
                        question: "Where does she live?",
                        options: ["Countryside", "City center", "Suburbs", "Near the park"],
                        correct: 1
                    },
                    {
                        question: "Where is the bus stop?",
                        options: ["Near her work", "In front of her building", "At the corner", "Far from home"],
                        correct: 1
                    }
                ]
            },
            {
                id: 'audio-09',
                title: 'Health and Body',
                description: 'Learn vocabulary about health, exercise, and body care',
                duration: '40s',
                icon: 'üí™',
                audioFile: 'audio-09-health.mp3',
                questions: [
                    {
                        question: "How often does she exercise?",
                        options: ["Every day", "Three times a week", "Once a week", "Never"],
                        correct: 1
                    },
                    {
                        question: "How many glasses of water does she drink?",
                        options: ["6", "7", "8", "10"],
                        correct: 2
                    },
                    {
                        question: "How many hours does she sleep?",
                        options: ["7 hours", "8 hours", "9 hours", "6 hours"],
                        correct: 1
                    },
                    {
                        question: "How often does she brush her teeth?",
                        options: ["Once a day", "Twice a day", "Three times a day", "Never"],
                        correct: 1
                    },
                    {
                        question: "What doesn't she do?",
                        options: ["Exercise", "Eat vegetables", "Smoke and drink alcohol", "Sleep"],
                        correct: 2
                    }
                ]
            },
            {
                id: 'audio-10',
                title: 'Future Plans',
                description: 'Learn to talk about future plans and aspirations',
                duration: '37s',
                icon: 'üöÄ',
                audioFile: 'audio-10-future.mp3',
                questions: [
                    {
                        question: "Where will she travel next month?",
                        options: ["Asia", "Europe", "America", "Africa"],
                        correct: 1
                    },
                    {
                        question: "How long will she stay?",
                        options: ["One week", "Two weeks", "Three weeks", "One month"],
                        correct: 1
                    },
                    {
                        question: "What will she do after her trip?",
                        options: ["Study more", "Start a new job", "Buy a house", "Move cities"],
                        correct: 1
                    },
                    {
                        question: "Which countries will she visit?",
                        options: ["France and Italy", "Italy and Spain", "France, Italy, and Spain", "Only France"],
                        correct: 2
                    },
                    {
                        question: "What languages is she learning?",
                        options: ["Spanish", "French", "French and Italian", "Italian"],
                        correct: 2
                    }
                ]
            }
        ];

        // State
        let currentLesson = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let studentData = null;
        let lessonStartTime = null;
        let audioPlayer = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üåü A1 Foundation Lessons Loading...');
            if (!checkAuth()) return;
            
            audioPlayer = document.getElementById('audioPlayer');
            initializeEventListeners();
            loadLessonsWithProgress();
            
            // Initialize header bar
            initializeHeaderBar();
        });

        // Initialize header bar functionality
        function initializeHeaderBar() {
            const currentStudent = getCurrentStudent();
            if (currentStudent) {
                const displayName = currentStudent.displayName || 'Estudante';
                document.getElementById('userCourseLine').textContent = `${displayName} ‚Ä¢ A1 Foundation Course`;
            }
        }

        function checkAuth() {
            if (!localStorage.getItem('studentLoggedIn')) {
                window.location.href = '../index.html';
                return false;
            }
            return true;
        }

        function getCurrentStudent() {
            const authData = localStorage.getItem('studentAuth');
            return authData ? JSON.parse(authData) : null;
        }

        // Load lessons with Firebase progress
        async function loadLessonsWithProgress() {
            try {
                const currentStudent = getCurrentStudent();
                if (!currentStudent) return;

                document.getElementById('firebaseStatus').innerHTML = '<span class="text-alex-blue font-medium">üîç Carregando progresso...</span>';

                const studentRef = doc(db, 'students', currentStudent.username);
                const studentDoc = await getDoc(studentRef);
                
                if (studentDoc.exists()) {
                    studentData = studentDoc.data();
                    const audioLessons = studentData.audioLessons || {};
                    
                    renderLessons(audioLessons);
                    
                    const completedCount = Object.values(audioLessons).filter(lesson => lesson.status === 'completed').length;
                    document.getElementById('firebaseStatus').innerHTML = `<span class="text-alex-blue font-bold">‚úÖ Firebase: ${completedCount}/10 Foundation lessons completed</span>`;
                } else {
                    document.getElementById('firebaseStatus').innerHTML = '<span class="text-academy-red font-medium">‚ùå Estudante n√£o encontrado</span>';
                    renderLessons({});
                }
            } catch (error) {
                console.error('‚ùå Error loading progress:', error);
                document.getElementById('firebaseStatus').innerHTML = '<span class="text-academy-red font-medium">‚ùå Erro Firebase - modo offline</span>';
                renderLessons({});
            }
        }

        function renderLessons(audioLessons) {
            const grid = document.getElementById('lessonsGrid');
            
            grid.innerHTML = LESSONS.map((lesson, index) => {
                const progress = audioLessons[lesson.id] || { status: 'not-started', score: 0, attempts: 0 };
                const statusClass = getStatusClass(progress.status);
                const statusText = getStatusText(progress.status);
                
                return `
                    <div class="lesson-card elegant-card rounded-xl p-4 cursor-pointer fade-in" onclick="startLesson('${lesson.id}')" style="animation-delay: ${index * 0.1}s">
                        <div class="lesson-card-header mb-3">
                            <div class="lesson-icon">${lesson.icon}</div>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <h3 class="heading-secondary mb-2">Lesson ${index + 1}: ${lesson.title}</h3>
                        <p class="text-muted mb-3">${lesson.description}</p>
                        <div class="lesson-card-footer">
                            <span class="lesson-duration">üéß ${lesson.duration}</span>
                            <span class="lesson-reward text-alex-blue font-medium">${progress.status === 'completed' ? `‚úÖ ${progress.score}/5` : '+50 XP'}</span>
                        </div>
                        ${progress.attempts > 0 ? `
                            <div class="lesson-attempts text-muted">
                                Tentativas: ${progress.attempts} ‚Ä¢ Score: ${progress.score || 0}/5
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function getStatusClass(status) {
            return {
                'completed': 'status-completed',
                'in-progress': 'status-in-progress',
                'not-started': 'status-not-started'
            }[status] || 'status-not-started';
        }

        function getStatusText(status) {
            return {
                'completed': 'Completed',
                'in-progress': 'In Progress', 
                'not-started': 'Available'
            }[status] || 'Available';
        }

        // Start lesson
        window.startLesson = function(lessonId) {
            currentLesson = LESSONS.find(l => l.id === lessonId);
            if (!currentLesson) return;

            lessonStartTime = Date.now();
            userAnswers = new Array(currentLesson.questions.length).fill(null);
            
            // Setup lesson interface
            document.getElementById('lessonSelection').classList.add('hidden');
            document.getElementById('lessonInterface').classList.remove('hidden');
            
            // Smooth scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Update lesson info
            const lessonIndex = LESSONS.findIndex(l => l.id === lessonId) + 1;
            document.getElementById('lessonProgress').textContent = `Lesson ${lessonIndex} of ${LESSONS.length}`;
            document.getElementById('lessonTitle').textContent = currentLesson.title;
            document.getElementById('lessonDescription').textContent = currentLesson.description;
            
            // Update header bar
            const currentStudent = getCurrentStudent();
            const displayName = currentStudent ? currentStudent.displayName : 'Estudante';
            document.getElementById('userCourseLine').textContent = `${displayName} ‚Ä¢ Foundation ${lessonIndex}: ${currentLesson.title}`;
            
            // Setup audio
            document.getElementById('audioSource').src = `../audio/a1-foundation/${currentLesson.audioFile}`;
            audioPlayer.load();
            
            // Load questions
            loadQuestions();
            
            // Reset progress
            updateProgress(0, 'Listen to Audio');
            
            console.log('üéØ Foundation lesson started:', currentLesson.title);
        };

        function loadQuestions() {
            const questionsSection = document.getElementById('questionsSection');
            
            questionsSection.innerHTML = currentLesson.questions.map((question, index) => `
                <div class="question-container slide-up" style="animation-delay: ${index * 0.1}s">
                    <div class="question-header mb-4">
                        <div class="question-number">${index + 1}</div>
                        <div class="text-muted">Question ${index + 1} of ${currentLesson.questions.length}</div>
                    </div>
                    
                    <h4 class="question-text mb-4">${question.question}</h4>
                    
                    <div class="answer-options">
                        ${question.options.map((option, optionIndex) => `
                            <div class="answer-option" data-question="${index}" data-option="${optionIndex}" onclick="selectAnswer(${index}, ${optionIndex})">
                                <div class="option-letter">${String.fromCharCode(65 + optionIndex)}</div>
                                <div class="option-text">${option}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        window.selectAnswer = function(questionIndex, optionIndex) {
            // Remove previous selections
            document.querySelectorAll(`[data-question="${questionIndex}"]`).forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add new selection
            const selectedOption = document.querySelector(`[data-question="${questionIndex}"][data-option="${optionIndex}"]`);
            selectedOption.classList.add('selected');
            selectedOption.classList.add('bounce-in');
            
            // Store answer
            userAnswers[questionIndex] = optionIndex;
            
            // Update submit button
            const answeredCount = userAnswers.filter(answer => answer !== null).length;
            const submitBtn = document.getElementById('submitAnswers');
            submitBtn.textContent = `Submit Answers (${answeredCount}/5 Complete)`;
            submitBtn.disabled = answeredCount < 5;
            
            if (answeredCount === 5) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Answers - Ready! üéØ';
                submitBtn.classList.add('pulse-gentle');
            }
            
            // Update progress
            const progress = 20 + (answeredCount / currentLesson.questions.length) * 80;
            updateProgress(progress, `${answeredCount}/5 Questions Answered`);
        };

        function updateProgress(percentage, text) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = `${percentage}%`;
            document.getElementById('progressText').textContent = text;
        }

        // Audio controls
        function initializeEventListeners() {
            // Audio controls
            document.getElementById('playPauseBtn').addEventListener('click', () => {
                if (audioPlayer.paused) {
                    audioPlayer.play();
                    document.getElementById('playPauseBtn').textContent = '‚è∏Ô∏è Pause';
                } else {
                    audioPlayer.pause();
                    document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è Play';
                }
            });
            
            document.getElementById('rewindBtn').addEventListener('click', () => {
                audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 10);
            });
            
            document.getElementById('forwardBtn').addEventListener('click', () => {
                audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 10);
            });
            
            // Speed controls
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const speed = parseFloat(btn.dataset.speed);
                    audioPlayer.playbackRate = speed;
                    
                    document.querySelector('.speed-btn.active').classList.remove('active');
                    btn.classList.add('active');
                });
            });
            
            // Submit answers
            document.getElementById('submitAnswers').addEventListener('click', submitAnswers);
            
            // Navigation
            document.getElementById('backToLessons').addEventListener('click', () => {
                document.getElementById('lessonInterface').classList.add('hidden');
                document.getElementById('lessonSelection').classList.remove('hidden');
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                const currentStudent = getCurrentStudent();
                const displayName = currentStudent ? currentStudent.displayName : 'Estudante';
                document.getElementById('userCourseLine').textContent = `${displayName} ‚Ä¢ A1 Foundation Course`;
            });
            
            // Results modal
            document.getElementById('nextLesson').addEventListener('click', goToNextLesson);
            document.getElementById('backToLessonsList').addEventListener('click', () => {
                closeResultsModal();
                returnToLessonsList();
            });
            
            // Try Again Button
            document.getElementById('tryAgainBtn').addEventListener('click', restartLesson);
            
            // Backdrop click to close modal
            document.getElementById('resultsModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('resultsModal')) {
                    closeResultsModal();
                    returnToLessonsList();
                }
            });
            
            document.getElementById('reviewModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('reviewModal')) {
                    document.getElementById('reviewModal').classList.add('hidden');
                }
            });
            
            // Review modal
            document.getElementById('reviewAnswers').addEventListener('click', showReviewModal);
            document.getElementById('closeReview').addEventListener('click', () => {
                document.getElementById('reviewModal').classList.add('hidden');
            });

            // Audio events
            audioPlayer.addEventListener('play', () => {
                updateProgress(20, 'Listening to Audio...');
            });
            
            audioPlayer.addEventListener('ended', () => {
                updateProgress(20, 'Audio Complete - Answer Questions Below');
            });
        }

        // Logout function
        window.logout = function() {
            localStorage.clear();
            window.location.href = '../index.html';
        };

        async function submitAnswers() {
            try {
                const score = calculateScore();
                const timeSpent = Math.floor((Date.now() - lessonStartTime) / 1000);
                const xpEarned = calculateXP(score);
                
                // Save to Firebase
                await saveLessonProgress(score, timeSpent, xpEarned);
                
                // Show results
                showResultsModal(score, xpEarned);
                
            } catch (error) {
                console.error('‚ùå Error submitting answers:', error);
                alert('Erro ao salvar progresso. Tente novamente.');
            }
        }

        function calculateScore() {
            return userAnswers.reduce((score, answer, index) => {
                return score + (answer === currentLesson.questions[index].correct ? 1 : 0);
            }, 0);
        }

        function calculateXP(score) {
            const baseXP = score * 10; // 10 XP per correct answer
            const bonusXP = score === 5 ? 25 : 0; // Perfect score bonus
            return baseXP + bonusXP;
        }

        // Complete lesson saving with level calculation
        async function saveLessonProgress(score, timeSpent, xpEarned) {
            const currentStudent = getCurrentStudent();
            if (!currentStudent) return;

            const studentRef = doc(db, 'students', currentStudent.username);
            const lessonPath = `audioLessons.${currentLesson.id}`;
            
            // Get existing lesson data for attempts increment
            const existingLesson = studentData?.audioLessons?.[currentLesson.id];
            const currentAttempts = existingLesson?.attempts || 0;
            
            // Calculate new total XP and level
            const currentTotalXP = studentData?.totalXP || 0;
            const newTotalXP = currentTotalXP + xpEarned;
            const newLevel = calculateLevelFromXP(newTotalXP);
            
            const updateData = {
                [lessonPath]: {
                    status: 'completed',
                    score: score,
                    totalQuestions: 5,
                    attempts: currentAttempts + 1,
                    completedAt: serverTimestamp(),
                    timeSpent: timeSpent,
                    xpEarned: xpEarned
                },
                totalXP: newTotalXP,
                level: newLevel,
                lastLoginDate: serverTimestamp()
            };

            await updateDoc(studentRef, updateData);
            
            // Update local data
            if (!studentData.audioLessons) studentData.audioLessons = {};
            studentData.audioLessons[currentLesson.id] = updateData[lessonPath];
            studentData.totalXP = newTotalXP;
            studentData.level = newLevel;
            
            console.log(`‚úÖ Foundation progress saved: +${xpEarned} XP, Level ${newLevel}`);
        }

        // Level calculation function
        function calculateLevelFromXP(totalXP) {
            if (totalXP < 100) return 1;
            
            let level = 1;
            let xpRequired = 0;
            
            while (totalXP >= xpRequired) {
                level++;
                xpRequired += (level - 1) * 150;
                if (level > 1000) break;
            }
            
            return Math.min(level - 1, 1000);
        }

        function showResultsModal(score, xpEarned) {
            const percentage = Math.round((score / 5) * 100);
            const isPerfect = score === 5;
            
            document.getElementById('resultIcon').textContent = isPerfect ? 'üèÜ' : score >= 4 ? 'üéØ' : 'üìù';
            document.getElementById('resultTitle').textContent = isPerfect ? 'Perfect Score!' : score >= 4 ? 'Great Job!' : 'Lesson Complete!';
            document.getElementById('scoreDisplay').textContent = `${score}/5`;
            document.getElementById('percentageDisplay').textContent = `${percentage}% Correct`;
            document.getElementById('xpEarned').textContent = `+${xpEarned} XP Earned!`;
            
            // Show/hide Try Again button based on score
            const tryAgainBtn = document.getElementById('tryAgainBtn');
            if (score < 5) {
                tryAgainBtn.classList.remove('hidden');
            } else {
                tryAgainBtn.classList.add('hidden');
            }
            
            // Check for achievements
            if (isPerfect) {
                document.getElementById('achievementDisplay').classList.remove('hidden');
                document.getElementById('achievementText').textContent = 'üéØ Perfect Foundation Score!';
            }
            
            document.getElementById('resultsModal').classList.remove('hidden');
        }

        function showReviewModal() {
            const reviewContent = document.getElementById('reviewContent');
            
            reviewContent.innerHTML = currentLesson.questions.map((question, index) => {
                const userAnswer = userAnswers[index];
                const isCorrect = userAnswer === question.correct;
                const correctAnswer = question.options[question.correct];
                const userAnswerText = question.options[userAnswer];
                
                return `
                    <div class="review-item">
                        <div class="heading-secondary mb-2">${index + 1}. ${question.question}</div>
                        <div class="review-answers">
                            <div class="${isCorrect ? 'text-success' : 'text-error'} font-medium">
                                ${isCorrect ? '‚úÖ' : '‚ùå'} Your answer: ${userAnswerText}
                            </div>
                            ${!isCorrect ? `
                                <div class="text-success font-medium">
                                    ‚úÖ Correct: ${correctAnswer}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('reviewModal').classList.remove('hidden');
        }

        function goToNextLesson() {
            const currentIndex = LESSONS.findIndex(l => l.id === currentLesson.id);
            const nextLesson = LESSONS[currentIndex + 1];
            
            closeResultsModal();
            
            if (nextLesson) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
                startLesson(nextLesson.id);
            } else {
                // Foundation course completed - return to lesson list
                returnToLessonsList();
                alert('üéâ Parab√©ns! Voc√™ completou todas as aulas do Foundation Course! Explore outros temas no Hub.');
            }
        }

        function closeResultsModal() {
            document.getElementById('resultsModal').classList.add('hidden');
        }

        // Restart current lesson function
        function restartLesson() {
            if (!currentLesson) return;
            
            // Close modal first
            closeResultsModal();
            
            // Reset lesson state
            userAnswers = new Array(currentLesson.questions.length).fill(null);
            lessonStartTime = Date.now();
            
            // Reset audio
            audioPlayer.currentTime = 0;
            audioPlayer.pause();
            document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è Play';
            
            // Reset questions (remove all selections)
            document.querySelectorAll('.answer-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Reset submit button
            const submitBtn = document.getElementById('submitAnswers');
            submitBtn.textContent = 'Submit Answers (0/5 Complete)';
            submitBtn.disabled = true;
            submitBtn.classList.remove('pulse-gentle');
            
            // Reset progress
            updateProgress(0, 'Listen to Audio');
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            console.log('üîÑ Foundation lesson restarted:', currentLesson.title);
        }

        // Return to lessons list helper
        function returnToLessonsList() {
            document.getElementById('lessonInterface').classList.add('hidden');
            document.getElementById('lessonSelection').classList.remove('hidden');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            const currentStudent = getCurrentStudent();
            const displayName = currentStudent ? currentStudent.displayName : 'Estudante';
            document.getElementById('userCourseLine').textContent = `${displayName} ‚Ä¢ A1 Foundation Course`;
        }
    </script>

    <!-- Enhanced Styles Using Your Sophisticated Design System -->
    <style>
        /* ========================================================================
           LAYOUT FOUNDATION - Using Your Sophisticated System
           ======================================================================== */

        /* Header */
        .bg-primary {
            background: var(--gradient-primary);
            box-shadow: var(--shadow-blue);
        }

        .header-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 1.25rem;
        }

        .brand-line {
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            text-align: center;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .user-course-line {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            text-align: center;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-portal {
            background: rgba(255, 255, 255, 0.9);
            color: var(--alex-blue);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-lg);
            font-size: 0.75rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-portal:hover {
            background: white;
            transform: translateY(-1px);
            box-shadow: var(--shadow-soft);
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-lg);
            font-size: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Main Layout */
        .lesson-container {
            padding-top: 5rem;
            min-height: 100vh;
        }

        .content-wrapper {
            max-width: 64rem;
            margin: 0 auto;
            padding: 0 1rem 2rem;
        }

        /* Course Header */
        .course-icon {
            font-size: 3rem;
        }

        .course-features {
            color: white;
            font-weight: 500;
        }

        /* Lessons Grid */
        .lessons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1rem;
        }

        .lesson-card {
            cursor: pointer;
        }

        .lesson-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lesson-icon {
            font-size: 1.5rem;
        }

        .lesson-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
        }

        .lesson-attempts {
            margin-top: 0.5rem;
            font-size: 0.75rem;
        }

        /* Lesson Interface */
        .lesson-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-container {
            background: rgba(59, 130, 246, 0.05);
            border-radius: var(--radius-lg);
            padding: 0.75rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
        }

        /* Audio Player Enhancements */
        .audio-enhanced {
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
        }

        /* Question Interface */
        .questions-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .question-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .option-text {
            flex: 1;
        }

        /* Submit Button */
        .submit-btn {
            padding: 1rem 2rem;
            border-radius: var(--radius-xl);
            font-size: 1.125rem;
            font-weight: bold;
        }

        /* Results Modal Enhancements */
        .result-icon {
            font-size: 3rem;
        }

        .score-display {
            font-size: 1.875rem;
            font-weight: bold;
            color: var(--charcoal);
        }

        .percentage-display {
            font-size: 1.125rem;
            color: var(--medium-gray);
        }

        .xp-display {
            color: var(--academy-red);
            font-weight: 600;
            font-size: 1.125rem;
        }

        .achievement-header {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--alex-blue);
        }

        .modal-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* Review Modal */
        .review-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .review-item {
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .review-item:last-child {
            border-bottom: none;
        }

        .review-answers {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }

        .text-success {
            color: var(--sage-green);
        }

        .text-error {
            color: var(--academy-red);
        }

        /* Utility Classes */
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .text-sm { font-size: 0.875rem; }
        .font-medium { font-weight: 500; }
        .font-bold { font-weight: 700; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mt-2 { margin-top: 0.5rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .cursor-pointer { cursor: pointer; }
        .hidden { display: none !important; }
        .z-50 { z-index: 50; }
        .fixed { position: fixed; }

        /* Desktop Responsive */
        @media (min-width: 768px) {
            .header-container {
                flex-direction: row;
                justify-content: space-between;
                padding: 0.75rem 2.5rem;
            }

            .brand-line {
                text-align: left;
            }

            .lesson-container {
                padding-top: 4rem;
            }

            .lessons-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
        }

        /* Mobile Adjustments */
        @media (max-width: 480px) {
            .content-wrapper {
                padding: 0 0.5rem 1rem;
            }

            .lessons-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .lesson-card {
                padding: 1rem;
            }

            .header-container {
                padding: 0.75rem 1rem;
                gap: 0.375rem;
            }

            .brand-line {
                font-size: 0.6875rem;
            }

            .user-course-line {
                font-size: 0.8125rem;
            }

            .btn-portal, .btn-logout {
                padding: 0.375rem 0.75rem;
                font-size: 0.6875rem;
            }

            .lesson-container {
                padding-top: 4.5rem;
            }
        }

        /* Enhanced Interactions */
        .lesson-card:hover {
            transform: translateY(-2px);
        }

        .answer-option:hover {
            transform: translateY(-1px);
        }

        .answer-option.selected {
            background: var(--alex-blue) !important;
            color: white !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .answer-option.selected .option-letter {
            background: white;
            color: var(--alex-blue);
        }

        .answer-option.selected .option-text {
            color: white !important;
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .submit-btn:not(:disabled):hover {
            transform: translateY(-2px);
        }
    </style>

</body>
</html>
