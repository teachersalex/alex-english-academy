<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Acad√™mico - Teacher Alex</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body class="sophisticated-bg min-h-screen">

    <!-- Header -->
    <div class="portal-header">
        <div class="max-w-sm mx-auto px-4 sm:max-w-md md:max-w-lg lg:max-w-2xl xl:max-w-4xl sm:px-6 md:px-8">
            <div class="brand-text">Teacher Alex English Academy</div>
            <div class="welcome-text" id="welcomeMessage">Bem-vindo(a) de volta, Estudante</div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-sm mx-auto px-4 sm:max-w-md md:max-w-lg lg:max-w-2xl xl:max-w-4xl sm:px-6 md:px-8 py-6 space-y-6">
        
        <!-- Progress Section -->
        <div class="elegant-card rounded-lg p-4 sm:p-5 md:p-6">
            <div class="text-center">
                <h2 id="levelDisplay" class="text-lg sm:text-xl md:text-2xl font-semibold text-charcoal mb-2">N√≠vel 1 ‚Ä¢ Beginner</h2>
                <div class="flex items-center justify-center space-x-4 sm:space-x-6 text-sm sm:text-base text-medium-gray mb-3">
                    <span id="xpDisplay">0 XP</span>
                    <span class="text-light-gray">‚Ä¢</span>
                    <span id="streakDisplay">Sequ√™ncia 0</span>
                </div>
                
                <!-- Lesson Progress Indicator -->
                <div class="bg-bg-subtle rounded-lg p-3 mt-3">
                    <div class="flex justify-between text-xs sm:text-sm text-medium-gray mb-1">
                        <span>Progresso das Aulas</span>
                        <span id="lessonProgress">0/10</span>
                    </div>
                    <div class="w-full bg-light-gray rounded-full h-2">
                        <div id="lessonProgressBar" class="bg-alex-blue h-2 rounded-full transition-all duration-500" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lesson Cards Section -->
        <div>
            <h2 class="text-lg sm:text-xl md:text-2xl font-semibold text-charcoal mb-4 sm:mb-5 md:mb-6">üéß Suas Aulas</h2>
            
            <div class="space-y-4 sm:space-y-5 md:space-y-6">
                
                <!-- Audio Lessons Card (Active) -->
                <div class="lesson-card-active">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h3 class="text-lg sm:text-xl font-semibold text-charcoal mb-1 sm:mb-2">üéµ AULAS DE √ÅUDIO</h3>
                            <p class="text-sm sm:text-base text-medium-gray mb-3 sm:mb-4">Acesse suas li√ß√µes interativas</p>
                        </div>
                        <div class="ml-4 text-2xl sm:text-3xl">‚îÄ‚îÄ‚ñ∫</div>
                    </div>
                    <a href="lessons.html" class="btn-primary w-full sm:w-auto inline-block text-center font-semibold py-3 px-6 rounded-lg text-sm sm:text-base no-underline">
                        INICIAR AULA
                    </a>
                </div>

                <!-- Exercises Card (Coming Soon) -->
                <div class="lesson-card-soon">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h3 class="text-lg sm:text-xl font-semibold text-medium-gray mb-1 sm:mb-2">üìù EXERC√çCIOS</h3>
                            <p class="text-sm sm:text-base text-medium-gray mb-3 sm:mb-4">Em desenvolvimento</p>
                        </div>
                        <div class="ml-4 text-2xl sm:text-3xl text-light-gray">‚îÄ‚îÄ‚îÄ‚îÄ</div>
                    </div>
                    <button class="btn-disabled w-full sm:w-auto font-semibold py-3 px-6 rounded-lg text-sm sm:text-base cursor-not-allowed">
                        EM BREVE
                    </button>
                </div>

                <!-- Conversation Card (Coming Soon) -->
                <div class="lesson-card-soon">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h3 class="text-lg sm:text-xl font-semibold text-medium-gray mb-1 sm:mb-2">üó£Ô∏è CONVERSA√á√ÉO</h3>
                            <p class="text-sm sm:text-base text-medium-gray mb-3 sm:mb-4">Em desenvolvimento</p>
                        </div>
                        <div class="ml-4 text-2xl sm:text-3xl text-light-gray">‚îÄ‚îÄ‚îÄ‚îÄ</div>
                    </div>
                    <button class="btn-disabled w-full sm:w-auto font-semibold py-3 px-6 rounded-lg text-sm sm:text-base cursor-not-allowed">
                        EM BREVE
                    </button>
                </div>

            </div>
        </div>

        <!-- Footer -->
        <div class="text-center pt-4 sm:pt-6 md:pt-8 pb-4">
            <p class="text-xs sm:text-sm text-medium-gray">
                ‚ÑπÔ∏è Sua revolu√ß√£o no ingl√™s come√ßa aqui ‚Ä¢ Teacher Alex English Academy
            </p>
        </div>

        <!-- Logout (Discrete) -->
        <div class="text-center pb-4">
            <button id="logoutBtn" class="text-xs text-light-gray hover:text-medium-gray transition-colors">
                Sair
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        // Simple auth check - avoid DOM conflicts
        function getCurrentStudent() {
            const authData = localStorage.getItem('studentAuth');
            return authData ? JSON.parse(authData) : null;
        }

        function isStudentAuthenticated() {
            const currentStudent = getCurrentStudent();
            if (!currentStudent || !currentStudent.isAuthenticated) return false;
            
            const loginTime = new Date(currentStudent.loginTime);
            const now = new Date();
            const hoursDiff = (now - loginTime) / (1000 * 60 * 60);
            
            return hoursDiff < 24;
        }

        // 1000-Level System with Exponential XP Scaling
        function calculateLevelFromXP(totalXP) {
            if (totalXP < 100) return 1;
            
            // Exponential scaling: Level 2 = 100 XP, Level 3 = 250 XP, Level 4 = 450 XP, etc.
            let level = 1;
            let xpRequired = 0;
            
            while (totalXP >= xpRequired) {
                level++;
                xpRequired += (level - 1) * 150; // Exponential increase
                if (level > 1000) break;
            }
            
            return Math.min(level - 1, 1000);
        }

        function getLevelCategory(level) {
            if (level <= 50) return 'Beginner';
            if (level <= 150) return 'Elementary';
            if (level <= 400) return 'Intermediate';
            if (level <= 700) return 'Advanced';
            return 'Expert';
        }

        function getXPForNextLevel(currentLevel) {
            if (currentLevel >= 1000) return 0;
            
            let totalXPNeeded = 0;
            for (let i = 2; i <= currentLevel + 1; i++) {
                totalXPNeeded += (i - 1) * 150;
            }
            return totalXPNeeded;
        }

        // Load REAL student data and update UI with lesson progress
        async function loadStudentData() {
            try {
                const currentStudent = getCurrentStudent();
                if (!currentStudent) return;

                // Update welcome message
                const displayName = currentStudent.displayName || 'Estudante';
                document.getElementById('welcomeMessage').textContent = `Bem-vindo(a) de volta, ${displayName}`;

                // CRITICAL: Load real Firebase data from lessons
                try {
                    const { getStudentOverallProgress } = await import('../js/progress-sync.js');
                    const progressResult = await getStudentOverallProgress();
                    
                    if (progressResult.success) {
                        const data = progressResult;
                        
                        // Calculate level from REAL XP earned in lessons
                        const realXP = data.profile.totalXP || 0;
                        const level = calculateLevelFromXP(realXP);
                        const category = getLevelCategory(level);
                        
                        // Update displays with REAL data
                        document.getElementById('levelDisplay').textContent = `N√≠vel ${level} ‚Ä¢ ${category}`;
                        document.getElementById('xpDisplay').textContent = `${realXP.toLocaleString('pt-BR')} XP`;
                        document.getElementById('streakDisplay').textContent = `Sequ√™ncia ${data.profile.currentStreak || 0}`;
                        
                        // Update lesson progress
                        const completedLessons = data.completedLessons || 0;
                        const totalLessons = data.totalLessons || 10;
                        const progressPercentage = (completedLessons / totalLessons) * 100;
                        
                        document.getElementById('lessonProgress').textContent = `${completedLessons}/${totalLessons}`;
                        document.getElementById('lessonProgressBar').style.width = `${progressPercentage}%`;
                        
                        // Log lesson completion data
                        // Check for recent achievements
                        const achievements = data.achievements || {};
                        const recentAchievements = Object.values(achievements)
                            .filter(ach => ach.unlocked && ach.unlockedAt)
                            .length;
                        
                        if (recentAchievements > 0) {
                            console.log(`üèÜ Student has ${recentAchievements} achievements unlocked!`);
                            showAchievementIndicator(recentAchievements);
                        }
                        
                        console.log(`üìä REAL Student Progress Loaded:`);
                        console.log(`   ‚Üí Level: ${level} (${category})`);
                        console.log(`   ‚Üí XP: ${realXP} (earned from lessons)`);
                        console.log(`   ‚Üí Lessons: ${completedLessons}/${totalLessons} completed (${Math.round(progressPercentage)}%)`);
                        console.log(`   ‚Üí Streak: ${data.profile.currentStreak || 0} days`);
                        console.log(`   ‚Üí Achievements: ${recentAchievements} unlocked`);
                        
                        // Success indicator
                        showDataLoadSuccess();
                        
                    } else {
                        console.warn('‚ö†Ô∏è Could not load Firebase data, using defaults');
                        showDefaultData();
                    }
                    
                } catch (error) {
                    console.error('‚ùå Firebase connection failed:', error);
                    showDefaultData();
                }
                
            } catch (error) {
                console.error('‚ùå Error loading student data:', error);
                showDefaultData();
            }
        }

        // Show default data when Firebase unavailable
        function showDefaultData() {
            document.getElementById('levelDisplay').textContent = 'N√≠vel 1 ‚Ä¢ Beginner';
            document.getElementById('xpDisplay').textContent = '0 XP';
            document.getElementById('streakDisplay').textContent = 'Sequ√™ncia 0';
            document.getElementById('lessonProgress').textContent = '0/10';
            document.getElementById('lessonProgressBar').style.width = '0%';
            console.log('üì¥ Using default data - Firebase unavailable');
        }

        // Visual indicator that real data loaded
        function showDataLoadSuccess() {
            // Add subtle success indicator
            const progressSection = document.querySelector('.elegant-card');
            progressSection.style.border = '1px solid #10b981';
            setTimeout(() => {
                progressSection.style.border = '';
            }, 2000);
        }

        // Show achievement indicator
        function showAchievementIndicator(count) {
            const levelDisplay = document.getElementById('levelDisplay');
            const originalText = levelDisplay.textContent;
            
            // Add achievement indicator
            levelDisplay.innerHTML = `${originalText} <span style="color: #f59e0b; font-size: 0.8em;">üèÜ ${count}</span>`;
            
            // Remove after 5 seconds
            setTimeout(() => {
                levelDisplay.textContent = originalText;
            }, 5000);
        }

        // Logout function
        async function handleLogout() {
            try {
                // Clean up session if possible
                const currentStudent = getCurrentStudent();
                if (currentStudent) {
                    try {
                        const { endCurrentSession } = await import('../js/progress-sync.js');
                        await endCurrentSession();
                    } catch (error) {
                        console.log('Session cleanup skipped:', error);
                    }
                }
                
                // Clear authentication
                localStorage.removeItem('studentAuth');
                localStorage.removeItem('studentLoggedIn');
                localStorage.removeItem('studentUsername');
                
                // Redirect to login
                window.location.href = '../index.html';
                
            } catch (error) {
                console.error('Logout error:', error);
                // Force redirect even if cleanup fails
                window.location.href = '../index.html';
            }
        }

        // Session protection
        if (!isStudentAuthenticated()) {
            window.location.href = '../index.html';
        }

        // Event listeners
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);

        // Initialize with data refresh capabilities
        document.addEventListener('DOMContentLoaded', () => {
            loadStudentData();
            
            // Refresh data when returning from lessons
            window.addEventListener('focus', () => {
                console.log('üîÑ Page focused - refreshing student data...');
                loadStudentData();
            });
            
            // Periodic refresh every 30 seconds
            setInterval(() => {
                loadStudentData();
            }, 30000);
            
            console.log('üöÄ Final Portal Design Loaded with REAL DATA SYNC!');
            console.log('üì± Responsive: ' + window.innerWidth + 'px');
            console.log('üîÑ Auto-refresh enabled for lesson progress');
        });
    </script>

    <!-- Custom Styles for Portal Components -->
    <style>
        .portal-header {
            background: white;
            text-align: center;
            padding: 1.5rem 1rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .brand-text {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--alex-blue);
            margin-bottom: 0.25rem;
        }

        .welcome-text {
            font-size: 0.75rem;
            color: var(--medium-gray);
        }

        .lesson-card-active {
            background: white;
            border: 2px solid var(--academy-red);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .lesson-card-active:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.15);
        }

        .lesson-card-soon {
            background: var(--bg-subtle);
            border: 2px solid var(--light-gray);
            border-radius: 0.75rem;
            padding: 1.5rem;
            opacity: 0.7;
        }

        .btn-primary {
            background: var(--academy-red);
            color: white;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #dc2626;
            transform: translateY(-1px);
            text-decoration: none;
        }

        .btn-disabled {
            background: var(--light-gray);
            color: #9ca3af;
        }

        .bg-alex-blue {
            background-color: var(--alex-blue);
        }

        .bg-bg-subtle {
            background-color: var(--bg-subtle);
        }

        @media (max-width: 640px) {
            .portal-header {
                padding: 1rem 0.75rem;
            }
            
            .lesson-card-active,
            .lesson-card-soon {
                padding: 1.25rem;
            }
        }
    </style>

</body>
</html>
