<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Magic - Teacher Alex Academy</title>
    <!-- PRODUCTION NOTE: Replace Tailwind CDN with local build -->
    <!-- See: https://tailwindcss.com/docs/installation -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body class="colorful-bg min-h-screen">

    <!-- Professional Colorful Header Bar -->
    <header class="colorful-header-bar">
        <div class="header-left">
            <div class="brand-line">Teacher Alex English Academy</div>
            <div class="user-course-line" id="userCourseLine">Alex12345 ‚Ä¢ Movie Magic</div>
        </div>
        
        <div class="header-actions">
            <button class="btn-portal" onclick="window.location.href='hub.html'">‚Üê Hub</button>
            <button class="btn-sair" onclick="logout()">Sair</button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="lesson-content">
        <div class="max-w-4xl mx-auto px-4 pb-8">
        
        <!-- Lesson Selection View -->
        <div id="lessonSelection">
            <!-- Course Header -->
            <div class="colorful-main-card rounded-xl p-6 mb-6">
                <div class="text-center">
                    <div class="text-5xl mb-4">üé¨</div>
                    <h2 class="text-2xl font-bold text-white mb-2">Movie Magic</h2>
                    <p class="text-blue-100 mb-4">Hollywood English and cinema conversations</p>
                    <div class="colorful-accent-card rounded-lg p-3">
                        <p class="text-white font-medium">üé≠ Complete movie quests ‚Ä¢ üìä Track progress ‚Ä¢ üèÜ Earn Cinema Lover achievement!</p>
                    </div>
                </div>
            </div>

            <!-- Firebase Status -->
            <div class="status-card rounded-lg p-4 mb-6 text-center">
                <div id="firebaseStatus" class="text-sm">
                    <span class="text-primary-blue font-medium">üî• Carregando progresso do Firebase...</span>
                </div>
            </div>

            <!-- Lessons Grid -->
            <div id="lessonsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Movie lessons will be loaded here -->
            </div>
        </div>

        <!-- Interactive Lesson View -->
        <div id="lessonInterface" class="hidden">
            <!-- Lesson Header -->
            <div class="professional-card rounded-xl p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <button id="backToLessons" class="link-sophisticated text-sm">‚Üê Back to Movie Magic</button>
                    <div id="lessonProgress" class="text-sm text-medium-gray">Movie 1 of 10</div>
                </div>
                
                <h2 id="lessonTitle" class="text-2xl font-bold text-foundation-primary mb-2">Going to the Cinema</h2>
                <p id="lessonDescription" class="text-medium-gray mb-4">Cinema dates and movie experiences</p>
                
                <!-- Progress Indicator -->
                <div class="progress-card rounded-lg p-3">
                    <div class="flex justify-between text-sm mb-2">
                        <span>Movie Progress</span>
                        <span id="progressText">Listen to Audio</span>
                    </div>
                    <div class="progress-bar-container h-3 rounded-full">
                        <div id="progressBar" class="progress-bar rounded-full"></div>
                    </div>
                </div>
            </div>

            <!-- Audio Player -->
            <div class="audio-card rounded-xl p-6 mb-6">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-semibold text-charcoal mb-2">üéß Listen to the Movie Audio</h3>
                    <p class="text-medium-gray">Listen carefully and answer the cinema questions below</p>
                </div>
                
                <audio id="audioPlayer" class="w-full mb-4" controls>
                    <source id="audioSource" src="" type="audio/mpeg">
                    Your browser does not support audio.
                </audio>
                
                <!-- Audio Controls -->
                <div class="flex justify-center space-x-4 mb-4">
                    <button id="playPauseBtn" class="btn-secondary px-6 py-2 rounded-lg">‚ñ∂Ô∏è Play</button>
                    <button id="rewindBtn" class="btn-subtle px-4 py-2 rounded-lg">‚è™ -10s</button>
                    <button id="forwardBtn" class="btn-subtle px-4 py-2 rounded-lg">‚è© +10s</button>
                </div>
                
                <!-- Speed Controls -->
                <div class="flex justify-center space-x-2">
                    <button class="speed-btn px-3 py-1 text-sm rounded" data-speed="0.75">0.75x</button>
                    <button class="speed-btn px-3 py-1 text-sm rounded active" data-speed="1">1x</button>
                    <button class="speed-btn px-3 py-1 text-sm rounded" data-speed="1.25">1.25x</button>
                </div>
            </div>

            <!-- Questions Section -->
            <div id="questionsSection" class="space-y-6 mb-6">
                <!-- Movie questions will be loaded here -->
            </div>

            <!-- Submit Section -->
            <div class="submit-card rounded-xl p-6 text-center">
                <button id="submitAnswers" class="btn-primary px-8 py-4 rounded-xl text-lg font-bold" disabled>
                    Complete Movie (0/5 Complete)
                </button>
                <p class="text-medium-gray text-sm mt-2">Answer all questions to complete the movie</p>
            </div>
        </div>
    </main>

    <!-- Results Modal -->
    <div id="resultsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="modal-card rounded-2xl p-6 max-w-md w-full">
            <div class="text-center">
                <div id="resultIcon" class="text-5xl mb-4">üéâ</div>
                <h3 id="resultTitle" class="text-xl font-bold text-charcoal mb-4">Movie Complete!</h3>
                
                <!-- Score Display -->
                <div class="score-card rounded-lg p-4 mb-4">
                    <div id="scoreDisplay" class="text-3xl font-bold text-charcoal mb-1">5/5</div>
                    <div id="percentageDisplay" class="text-lg text-medium-gray mb-2">100% Correct</div>
                    <div id="xpEarned" class="text-accent-red font-semibold text-lg">+75 XP Earned!</div>
                </div>
                
                <!-- Achievement -->
                <div id="achievementDisplay" class="hidden achievement-card rounded-lg p-3 mb-4">
                    <div class="text-sm font-semibold text-foundation-primary mb-2">üéâ Achievement Unlocked!</div>
                    <div id="achievementText" class="font-medium"></div>
                </div>
                
                <!-- Controls -->
                <div class="space-y-3">
                    <button id="reviewAnswers" class="btn-secondary w-full py-3 rounded-lg font-semibold">
                        üìä Review Answers
                    </button>
                    <!-- ‚úÖ FIXED: Try Again Button (appears when score < 5) -->
                    <button id="tryAgainBtn" class="btn-subtle w-full py-3 rounded-lg font-semibold hidden">
                        üîÑ Tentar Novamente
                    </button>
                    <button id="nextLesson" class="btn-primary w-full py-3 rounded-lg font-semibold">
                        Next Movie ‚Üí
                    </button>
                    <button id="backToLessonsList" class="link-muted text-sm py-2">
                        Back to Movie Magic
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Answer Review Modal -->
    <div id="reviewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="modal-card rounded-2xl p-6 max-w-2xl w-full max-h-96 overflow-y-auto">
            <h3 class="text-lg font-bold text-charcoal mb-4 text-center">üìù Movie Review</h3>
            <div id="reviewContent" class="space-y-4 mb-6">
                <!-- Review content here -->
            </div>
            <button id="closeReview" class="btn-primary w-full py-3 rounded-lg font-semibold">
                Close Review
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module" src="../js/firebase.js"></script>

    <!-- Complete Movie Magic System -->
    <script type="module">
        import { db } from '../js/firebase.js';
        import { doc, getDoc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js';

        // ‚úÖ FIXED: Complete Movie Magic lesson data - EXACTLY matching the scripts provided
        const MOVIE_LESSONS = [
            {
                id: 'movie-01',
                title: 'Going to the Cinema',
                description: 'Cinema dates and movie experiences',
                duration: '38s',
                icon: 'üé¨',
                audioFile: 'audio-01-cinema-date.mp3',
                questions: [
                    {
                        question: "Who did she go to the cinema with?",
                        options: ["Her sister", "Her friend", "Her boyfriend", "Her mom"],
                        correct: 2
                    },
                    {
                        question: "How much did each ticket cost?",
                        options: ["20 reais", "25 reais", "30 reais", "35 reais"],
                        correct: 1
                    },
                    {
                        question: "What type of movie did they watch?",
                        options: ["Comedy", "Horror", "Marvel movie", "Romance"],
                        correct: 2
                    },
                    {
                        question: "How early did they arrive?",
                        options: ["10 minutes", "15 minutes", "20 minutes", "30 minutes"],
                        correct: 1
                    },
                    {
                        question: "Where did they go after the movie?",
                        options: ["Home", "McDonald's", "Another cinema", "The park"],
                        correct: 1
                    }
                ]
            },
            {
                id: 'movie-02',
                title: 'Netflix Night at Home',
                description: 'Streaming services and binge watching',
                duration: '36s',
                icon: 'üì∫',
                audioFile: 'audio-02-netflix-night.mp3',
                questions: [
                    {
                        question: "Which series did she watch?",
                        options: ["The Crown", "Stranger Things", "Bridgerton", "Money Heist"],
                        correct: 1
                    },
                    {
                        question: "How many episodes did she watch?",
                        options: ["2", "3", "4", "5"],
                        correct: 1
                    },
                    {
                        question: "What did she drink while watching?",
                        options: ["Coffee", "Tea", "Hot chocolate", "Soda"],
                        correct: 2
                    },
                    {
                        question: "What time did she start watching?",
                        options: ["7 PM", "8 PM", "9 PM", "10 PM"],
                        correct: 1
                    },
                    {
                        question: "How many times did she pause?",
                        options: ["Once", "Twice", "Three times", "Four times"],
                        correct: 1
                    }
                ]
            },
            {
                id: 'movie-03',
                title: 'My Favorite Movie Genres',
                description: 'Different movie types and preferences',
                duration: '40s',
                icon: 'üé≠',
                audioFile: 'audio-03-movie-genres.mp3',
                questions: [
                    {
                        question: "What is her favorite movie genre?",
                        options: ["Action", "Horror", "Romantic comedies", "Science fiction"],
                        correct: 2
                    },
                    {
                        question: "Which actor is in her favorite rom-com?",
                        options: ["Brad Pitt", "Ryan Gosling", "Leonardo DiCaprio", "Will Smith"],
                        correct: 1
                    },
                    {
                        question: "Why does she hate horror movies?",
                        options: ["They're boring", "They give her nightmares", "They're too long", "They're expensive"],
                        correct: 1
                    },
                    {
                        question: "How old is her nephew?",
                        options: ["4 years old", "5 years old", "6 years old", "7 years old"],
                        correct: 2
                    },
                    {
                        question: "What does she think about science fiction?",
                        options: ["It's boring", "It's scary", "It's interesting but complicated", "It's her favorite"],
                        correct: 2
                    }
                ]
            },
            {
                id: 'movie-04',
                title: 'Binge Watching Weekend',
                description: 'Marathon viewing and streaming habits',
                duration: '39s',
                icon: 'üì±',
                audioFile: 'audio-04-binge-watching.mp3',
                questions: [
                    {
                        question: "Which series did she binge watch?",
                        options: ["Stranger Things", "Wednesday", "The Crown", "Emily in Paris"],
                        correct: 1
                    },
                    {
                        question: "How many episodes are in the first season?",
                        options: ["6", "7", "8", "10"],
                        correct: 2
                    },
                    {
                        question: "What did she order on Saturday?",
                        options: ["Chinese food", "Pizza", "Hamburgers", "Sushi"],
                        correct: 1
                    },
                    {
                        question: "What time did she start on Saturday?",
                        options: ["8 AM", "9 AM", "10 AM", "11 AM"],
                        correct: 1
                    },
                    {
                        question: "How many episodes will she watch per day next weekend?",
                        options: ["1", "2", "3", "4"],
                        correct: 1
                    }
                ]
            },
            {
                id: 'movie-05',
                title: 'Movie Review Blog',
                description: 'Writing reviews and film criticism',
                duration: '37s',
                icon: '‚úçÔ∏è',
                audioFile: 'audio-05-movie-reviews.mp3',
                questions: [
                    {
                        question: "How many stars did she give Spider-Man?",
                        options: ["3 out of 5", "4 out of 5", "5 out of 5", "2 out of 5"],
                        correct: 1
                    },
                    {
                        question: "What was excellent about the movie?",
                        options: ["The story", "The music", "The acting", "The length"],
                        correct: 2
                    },
                    {
                        question: "How many views did her review get in the first hour?",
                        options: ["300", "400", "500", "600"],
                        correct: 2
                    },
                    {
                        question: "How many times does she watch movies before reviewing?",
                        options: ["Once", "Twice", "Three times", "Four times"],
                        correct: 1
                    },
                    {
                        question: "How does writing reviews help her English?",
                        options: ["Grammar practice", "Speaking practice", "Vocabulary improvement", "Listening practice"],
                        correct: 2
                    }
                ]
            },
            {
                id: 'movie-06',
                title: 'Streaming Services Comparison',
                description: 'Netflix, Amazon Prime, and Disney Plus',
                duration: '41s',
                icon: 'üìä',
                audioFile: 'audio-06-streaming-services.mp3',
                questions: [
                    {
                        question: "How much does Netflix cost per month?",
                        options: ["30 reais", "35 reais", "40 reais", "45 reais"],
                        correct: 1
                    },
                    {
                        question: "Which service costs 15 reais monthly?",
                        options: ["Netflix", "Disney Plus", "Amazon Prime", "HBO Max"],
                        correct: 2
                    },
                    {
                        question: "How many hours does she watch daily?",
                        options: ["3 hours", "4 hours", "5 hours", "6 hours"],
                        correct: 1
                    },
                    {
                        question: "Which show does she mention from Netflix?",
                        options: ["Wednesday", "Stranger Things", "Squid Game", "The Crown"],
                        correct: 2
                    },
                    {
                        question: "What extra benefit does Amazon Prime include?",
                        options: ["Free movies", "Free shipping", "Free music", "Free books"],
                        correct: 1
                    }
                ]
            },
            {
                id: 'movie-07',
                title: 'Cinema Date Night',
                description: 'First dates and movie choices',
                duration: '35s',
                icon: 'üíï',
                audioFile: 'audio-07-cinema-first-date.mp3',
                questions: [
                    {
                        question: "What time are they meeting?",
                        options: ["7:00 PM", "7:30 PM", "8:00 PM", "8:30 PM"],
                        correct: 1
                    },
                    {
                        question: "Where did she meet her date?",
                        options: ["Instagram", "Facebook", "Tinder", "Work"],
                        correct: 2
                    },
                    {
                        question: "What type of movie did she choose?",
                        options: ["Horror", "Action", "Romantic comedy", "Drama"],
                        correct: 2
                    },
                    {
                        question: "What color dress is she wearing?",
                        options: ["Red", "Black", "Blue", "White"],
                        correct: 2
                    },
                    {
                        question: "Why are cinema dates perfect for first meetings?",
                        options: ["They're cheap", "Movies are fun", "You can talk about the movie", "It's dark"],
                        correct: 2
                    }
                ]
            },
            {
                id: 'movie-08',
                title: 'Classic Movies vs Modern',
                description: 'Comparing old and new cinema',
                duration: '42s',
                icon: 'üéûÔ∏è',
                audioFile: 'audio-08-classic-vs-modern.mp3',
                questions: [
                    {
                        question: "Which classic movie did she watch?",
                        options: ["Gone with the Wind", "Casablanca", "Roman Holiday", "Singin' in the Rain"],
                        correct: 1
                    },
                    {
                        question: "What year was the classic movie made?",
                        options: ["1940", "1941", "1942", "1943"],
                        correct: 2
                    },
                    {
                        question: "Which modern movie did she compare it to?",
                        options: ["Avatar", "Titanic", "The Avengers", "Star Wars"],
                        correct: 1
                    },
                    {
                        question: "What do classic movies have that's better?",
                        options: ["Special effects", "Sound quality", "Storytelling and dialogue", "Action scenes"],
                        correct: 2
                    },
                    {
                        question: "What do modern films have that's incredible?",
                        options: ["Stories", "Actors", "Music", "Special effects and sound"],
                        correct: 3
                    }
                ]
            },
            {
                id: 'movie-09',
                title: 'Movie Theater Experience',
                description: 'IMAX, sound effects, and cinema atmosphere',
                duration: '44s',
                icon: 'üçø',
                audioFile: 'audio-09-theater-experience.mp3',
                questions: [
                    {
                        question: "Which movie did she watch in IMAX?",
                        options: ["Avatar", "Dune", "Top Gun", "Spider-Man"],
                        correct: 1
                    },
                    {
                        question: "Which row does she prefer for the best viewing angle?",
                        options: ["Row F", "Row G", "Row H", "Row I"],
                        correct: 2
                    },
                    {
                        question: "What made her seat vibrate?",
                        options: ["The air conditioning", "Other people", "Sound effects", "The movie length"],
                        correct: 2
                    },
                    {
                        question: "What does she find annoying at the cinema?",
                        options: ["Expensive tickets", "People talking", "Loud sound", "Long lines"],
                        correct: 1
                    },
                    {
                        question: "When does she think theaters are worth the expense?",
                        options: ["For any movie", "For romantic films", "For big blockbusters", "For horror movies"],
                        correct: 2
                    }
                ]
            },
            {
                id: 'movie-10',
                title: 'Movie Awards Night',
                description: 'Oscar parties and award ceremonies',
                duration: '40s',
                icon: 'üèÜ',
                audioFile: 'audio-10-awards-night.mp3',
                questions: [
                    {
                        question: "How many friends came to her Oscar party?",
                        options: ["6", "7", "8", "9"],
                        correct: 2
                    },
                    {
                        question: "What time did they start watching in Brazilian time?",
                        options: ["8 PM", "9 PM", "10 PM", "11 PM"],
                        correct: 1
                    },
                    {
                        question: "How many categories did she guess correctly?",
                        options: ["5", "6", "7", "8"],
                        correct: 1
                    },
                    {
                        question: "Who won their betting pool?",
                        options: ["She did", "Carlos", "Her sister", "Nobody"],
                        correct: 1
                    },
                    {
                        question: "What prize did the winner receive?",
                        options: ["Money", "A movie ticket", "A bottle of champagne", "A trophy"],
                        correct: 2
                    }
                ]
            }
        ];

        // State variables (exact copy from Foundation system)
        let currentLesson = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let studentData = null;
        let lessonStartTime = null;
        let audioPlayer = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üé¨ Movie Magic Lessons Loading...');
            if (!checkAuth()) return;
            
            audioPlayer = document.getElementById('audioPlayer');
            initializeEventListeners();
            loadLessonsWithProgress();
            initializeHeaderBar();
        });

        function checkAuth() {
            if (!localStorage.getItem('studentLoggedIn')) {
                window.location.href = '../index.html';
                return false;
            }
            return true;
        }

        function getCurrentStudent() {
            const authData = localStorage.getItem('studentAuth');
            return authData ? JSON.parse(authData) : null;
        }

        function initializeHeaderBar() {
            const currentStudent = getCurrentStudent();
            if (currentStudent) {
                const displayName = currentStudent.displayName || 'Estudante';
                document.getElementById('userCourseLine').textContent = `${displayName} ‚Ä¢ Movie Magic`;
            }
        }

        // Load lessons with Firebase progress
        async function loadLessonsWithProgress() {
            try {
                const currentStudent = getCurrentStudent();
                if (!currentStudent) return;

                document.getElementById('firebaseStatus').innerHTML = '<span class="text-foundation-primary font-bold">üîç Carregando progresso...</span>';

                const studentRef = doc(db, 'students', currentStudent.username);
                const studentDoc = await getDoc(studentRef);
                
                if (studentDoc.exists()) {
                    studentData = studentDoc.data();
                    const movieLessons = studentData.movieLessons || {};
                    
                    renderLessons(movieLessons);
                    
                    const completedCount = Object.values(movieLessons).filter(lesson => lesson.status === 'completed').length;
                    document.getElementById('firebaseStatus').innerHTML = `<span class="text-foundation-primary font-bold">‚úÖ Firebase: ${completedCount}/10 Movie Magic lessons completed</span>`;
                } else {
                    document.getElementById('firebaseStatus').innerHTML = '<span class="text-error-red font-medium">‚ùå Estudante n√£o encontrado</span>';
                    renderLessons({});
                }
            } catch (error) {
                console.error('‚ùå Error loading progress:', error);
                document.getElementById('firebaseStatus').innerHTML = '<span class="text-error-red font-medium">‚ùå Erro Firebase - modo offline</span>';
                renderLessons({});
            }
        }

        function renderLessons(movieLessons) {
            const grid = document.getElementById('lessonsGrid');
            
            grid.innerHTML = MOVIE_LESSONS.map((lesson, index) => {
                const progress = movieLessons[lesson.id] || { status: 'not-started', score: 0, attempts: 0 };
                const statusClass = getStatusClass(progress.status);
                const statusText = getStatusText(progress.status);
                
                return `
                    <div class="lesson-card professional-card rounded-xl p-4 cursor-pointer hover:scale-105 transition-all" onclick="startLesson('${lesson.id}')">
                        <div class="flex items-center justify-between mb-3">
                            <div class="text-2xl">${lesson.icon}</div>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <h3 class="font-semibold text-charcoal mb-2">Movie ${index + 1}: ${lesson.title}</h3>
                        <p class="text-sm text-medium-gray mb-3">${lesson.description}</p>
                        <div class="flex items-center justify-between text-xs text-medium-gray">
                            <span>üé¨ ${lesson.duration}</span>
                            <span class="font-semibold text-foundation-primary">${progress.status === 'completed' ? `‚úÖ ${progress.score}/5` : '+50 XP'}</span>
                        </div>
                        ${progress.attempts > 0 ? `
                            <div class="mt-2 text-xs text-medium-gray">
                                Tentativas: ${progress.attempts} ‚Ä¢ Score: ${progress.score || 0}/5
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function getStatusClass(status) {
            return {
                'completed': 'status-completed',
                'in-progress': 'status-in-progress',
                'not-started': 'status-not-started'
            }[status] || 'status-not-started';
        }

        function getStatusText(status) {
            return {
                'completed': 'Completed',
                'in-progress': 'In Progress', 
                'not-started': 'Available'
            }[status] || 'Available';
        }

        // Start lesson function
        window.startLesson = function(lessonId) {
            currentLesson = MOVIE_LESSONS.find(l => l.id === lessonId);
            if (!currentLesson) return;

            lessonStartTime = Date.now();
            userAnswers = new Array(currentLesson.questions.length).fill(null);
            
            // Setup lesson interface
            document.getElementById('lessonSelection').classList.add('hidden');
            document.getElementById('lessonInterface').classList.remove('hidden');
            
            // ‚úÖ SCROLL TO TOP FOR BETTER UX
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Update lesson info
            const lessonIndex = MOVIE_LESSONS.findIndex(l => l.id === lessonId) + 1;
            document.getElementById('lessonProgress').textContent = `Movie ${lessonIndex} of ${MOVIE_LESSONS.length}`;
            document.getElementById('lessonTitle').textContent = currentLesson.title;
            document.getElementById('lessonDescription').textContent = currentLesson.description;
            
            // Update header bar
            const currentStudent = getCurrentStudent();
            const displayName = currentStudent ? currentStudent.displayName : 'Estudante';
            document.getElementById('userCourseLine').textContent = `${displayName} ‚Ä¢ Movie ${lessonIndex}: ${currentLesson.title}`;
            
            // Setup audio (corrected path for a1-movies folder)
            document.getElementById('audioSource').src = `../audio/a1-movies/${currentLesson.audioFile}`;
            audioPlayer.load();
            
            // Load questions
            loadQuestions();
            
            // Reset progress
            updateProgress(0, 'Listen to Audio');
            
            console.log('üéØ Movie Magic lesson started:', currentLesson.title);
        };

        function loadQuestions() {
            const questionsSection = document.getElementById('questionsSection');
            
            questionsSection.innerHTML = currentLesson.questions.map((question, index) => `
                <div class="question-card rounded-xl p-6">
                    <div class="flex items-center mb-4">
                        <div class="w-8 h-8 bg-foundation-primary text-white rounded-full flex items-center justify-center font-bold text-sm mr-3">
                            ${index + 1}
                        </div>
                        <div class="text-sm text-medium-gray">Question ${index + 1} of ${currentLesson.questions.length}</div>
                    </div>
                    
                    <h4 class="text-lg font-semibold text-charcoal mb-4">${question.question}</h4>
                    
                    <div class="space-y-3">
                        ${question.options.map((option, optionIndex) => `
                            <div class="answer-option cursor-pointer" data-question="${index}" data-option="${optionIndex}" onclick="selectAnswer(${index}, ${optionIndex})">
                                <div class="option-letter">${String.fromCharCode(65 + optionIndex)}</div>
                                <div class="flex-1">${option}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        window.selectAnswer = function(questionIndex, optionIndex) {
            // Remove previous selections
            document.querySelectorAll(`[data-question="${questionIndex}"]`).forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add new selection
            document.querySelector(`[data-question="${questionIndex}"][data-option="${optionIndex}"]`)
                .classList.add('selected');
            
            // Store answer
            userAnswers[questionIndex] = optionIndex;
            
            // Update submit button
            const answeredCount = userAnswers.filter(answer => answer !== null).length;
            const submitBtn = document.getElementById('submitAnswers');
            submitBtn.textContent = `Complete Movie (${answeredCount}/5 Complete)`;
            submitBtn.disabled = answeredCount < 5;
            
            if (answeredCount === 5) {
                submitBtn.classList.remove('opacity-50');
                submitBtn.textContent = 'Complete Movie - Ready! üé¨';
            }
            
            // Update progress
            const progress = 20 + (answeredCount / currentLesson.questions.length) * 80;
            updateProgress(progress, `${answeredCount}/5 Questions Answered`);
        };

        function updateProgress(percentage, text) {
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressText').textContent = text;
        }

        function initializeEventListeners() {
            // Audio controls (same as Foundation)
            document.getElementById('playPauseBtn').addEventListener('click', () => {
                if (audioPlayer.paused) {
                    audioPlayer.play();
                    document.getElementById('playPauseBtn').textContent = '‚è∏Ô∏è Pause';
                } else {
                    audioPlayer.pause();
                    document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è Play';
                }
            });
            
            document.getElementById('rewindBtn').addEventListener('click', () => {
                audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 10);
            });
            
            document.getElementById('forwardBtn').addEventListener('click', () => {
                audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 10);
            });
            
            // Speed controls
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const speed = parseFloat(btn.dataset.speed);
                    audioPlayer.playbackRate = speed;
                    
                    document.querySelector('.speed-btn.active').classList.remove('active');
                    btn.classList.add('active');
                });
            });
            
            // Submit answers
            document.getElementById('submitAnswers').addEventListener('click', submitAnswers);
            
            // Navigation
            document.getElementById('backToLessons').addEventListener('click', () => {
                document.getElementById('lessonInterface').classList.add('hidden');
                document.getElementById('lessonSelection').classList.remove('hidden');
                
                // ‚úÖ SCROLL TO TOP WHEN RETURNING TO LESSON LIST
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                const currentStudent = getCurrentStudent();
                const displayName = currentStudent ? currentStudent.displayName : 'Estudante';
                document.getElementById('userCourseLine').textContent = `${displayName} ‚Ä¢ Movie Magic`;
            });

            // Results modal
            document.getElementById('nextLesson').addEventListener('click', goToNextLesson);
            document.getElementById('backToLessonsList').addEventListener('click', () => {
                closeResultsModal();
                returnToLessonsList();
            });
            
            // ‚úÖ FIXED: Try Again Button
            document.getElementById('tryAgainBtn').addEventListener('click', restartLesson);
            
            // ‚úÖ FIXED: Backdrop click to close modal
            document.getElementById('resultsModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('resultsModal')) {
                    closeResultsModal();
                    returnToLessonsList();
                }
            });
            
            // ‚úÖ FIXED: Backdrop click for review modal too
            document.getElementById('reviewModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('reviewModal')) {
                    document.getElementById('reviewModal').classList.add('hidden');
                }
            });
            
            // Review modal
            document.getElementById('reviewAnswers').addEventListener('click', showReviewModal);
            document.getElementById('closeReview').addEventListener('click', () => {
                document.getElementById('reviewModal').classList.add('hidden');
            });

            // Audio events
            audioPlayer.addEventListener('play', () => {
                updateProgress(20, 'Listening to Audio...');
            });
            
            audioPlayer.addEventListener('ended', () => {
                updateProgress(20, 'Audio Complete - Answer Questions Below');
            });
        }

        async function submitAnswers() {
            try {
                const score = calculateScore();
                const timeSpent = Math.floor((Date.now() - lessonStartTime) / 1000);
                const xpEarned = calculateXP(score);
                
                // Save to Firebase (movie lessons)
                await saveLessonProgress(score, timeSpent, xpEarned);
                
                // Show results
                showResultsModal(score, xpEarned);
                
            } catch (error) {
                console.error('‚ùå Error submitting answers:', error);
                alert('Erro ao salvar progresso. Tente novamente.');
            }
        }

        function calculateScore() {
            return userAnswers.reduce((score, answer, index) => {
                return score + (answer === currentLesson.questions[index].correct ? 1 : 0);
            }, 0);
        }

        function calculateXP(score) {
            const baseXP = score * 10; // 10 XP per correct answer
            const bonusXP = score === 5 ? 25 : 0; // Perfect score bonus
            return baseXP + bonusXP;
        }

        async function saveLessonProgress(score, timeSpent, xpEarned) {
            const currentStudent = getCurrentStudent();
            if (!currentStudent) return;

            const studentRef = doc(db, 'students', currentStudent.username);
            const lessonPath = `movieLessons.${currentLesson.id}`;
            
            const existingLesson = studentData?.movieLessons?.[currentLesson.id];
            const currentAttempts = existingLesson?.attempts || 0;
            
            const currentTotalXP = studentData?.totalXP || 0;
            const newTotalXP = currentTotalXP + xpEarned;
            const newLevel = calculateLevelFromXP(newTotalXP);
            
            const updateData = {
                [lessonPath]: {
                    status: 'completed',
                    score: score,
                    totalQuestions: 5,
                    attempts: currentAttempts + 1,
                    completedAt: serverTimestamp(),
                    timeSpent: timeSpent,
                    xpEarned: xpEarned
                },
                totalXP: newTotalXP,
                level: newLevel,
                lastLoginDate: serverTimestamp()
            };

            await updateDoc(studentRef, updateData);
            
            if (!studentData.movieLessons) studentData.movieLessons = {};
            studentData.movieLessons[currentLesson.id] = updateData[lessonPath];
            studentData.totalXP = newTotalXP;
            studentData.level = newLevel;
            
            console.log(`‚úÖ Movie Magic progress saved: +${xpEarned} XP, Level ${newLevel}`);
        }

        function calculateLevelFromXP(totalXP) {
            if (totalXP < 100) return 1;
            
            let level = 1;
            let xpRequired = 0;
            
            while (totalXP >= xpRequired) {
                level++;
                xpRequired += (level - 1) * 150;
                if (level > 1000) break;
            }
            
            return Math.min(level - 1, 1000);
        }

        function showResultsModal(score, xpEarned) {
            const percentage = Math.round((score / 5) * 100);
            const isPerfect = score === 5;
            
            document.getElementById('resultIcon').textContent = isPerfect ? 'üèÜ' : score >= 4 ? 'üé¨' : 'üìù';
            document.getElementById('resultTitle').textContent = isPerfect ? 'Perfect Movie!' : score >= 4 ? 'Great Cinema!' : 'Movie Complete!';
            document.getElementById('scoreDisplay').textContent = `${score}/5`;
            document.getElementById('percentageDisplay').textContent = `${percentage}% Correct`;
            document.getElementById('xpEarned').textContent = `+${xpEarned} XP Earned!`;
            
            // ‚úÖ FIXED: Show/hide Try Again button based on score
            const tryAgainBtn = document.getElementById('tryAgainBtn');
            if (score < 5) {
                tryAgainBtn.classList.remove('hidden');
            } else {
                tryAgainBtn.classList.add('hidden');
            }
            
            if (isPerfect) {
                document.getElementById('achievementDisplay').classList.remove('hidden');
                document.getElementById('achievementText').textContent = 'üé≠ Cinema Lover Perfect Score!';
            }
            
            document.getElementById('resultsModal').classList.remove('hidden');
        }

        function showReviewModal() {
            const reviewContent = document.getElementById('reviewContent');
            
            reviewContent.innerHTML = currentLesson.questions.map((question, index) => {
                const userAnswer = userAnswers[index];
                const isCorrect = userAnswer === question.correct;
                const correctAnswer = question.options[question.correct];
                const userAnswerText = question.options[userAnswer];
                
                return `
                    <div class="border-b border-soft-border pb-4 last:border-b-0">
                        <div class="font-medium text-charcoal mb-2">${index + 1}. ${question.question}</div>
                        <div class="space-y-1">
                            <div class="${isCorrect ? 'text-success-green' : 'text-error-red'} font-medium">
                                ${isCorrect ? '‚úÖ' : '‚ùå'} Your answer: ${userAnswerText}
                            </div>
                            ${!isCorrect ? `
                                <div class="text-success-green font-medium">
                                    ‚úÖ Correct: ${correctAnswer}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('reviewModal').classList.remove('hidden');
        }

        function goToNextLesson() {
            const currentIndex = MOVIE_LESSONS.findIndex(l => l.id === currentLesson.id);
            const nextLesson = MOVIE_LESSONS[currentIndex + 1];
            
            closeResultsModal();
            
            if (nextLesson) {
                // ‚úÖ SCROLL TO TOP WHEN ADVANCING TO NEXT LESSON
                window.scrollTo({ top: 0, behavior: 'smooth' });
                startLesson(nextLesson.id);
            } else {
                // Movie course completed - return to movie list
                returnToLessonsList();
                alert('üéâ Parab√©ns! Voc√™ completou todas as Movie Magic lessons! üé¨ Cinema Lover Achievement unlocked! Explore outros temas no Hub.');
            }
        }

        function closeResultsModal() {
            document.getElementById('resultsModal').classList.add('hidden');
        }

        // ‚úÖ FIXED: Restart current lesson function
        function restartLesson() {
            if (!currentLesson) return;
            
            // Close modal first
            closeResultsModal();
            
            // Reset lesson state
            userAnswers = new Array(currentLesson.questions.length).fill(null);
            lessonStartTime = Date.now();
            
            // Reset audio
            audioPlayer.currentTime = 0;
            audioPlayer.pause();
            document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è Play';
            
            // Reset questions (remove all selections)
            document.querySelectorAll('.answer-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Reset submit button
            const submitBtn = document.getElementById('submitAnswers');
            submitBtn.textContent = 'Complete Movie (0/5 Complete)';
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50');
            
            // Reset progress
            updateProgress(0, 'Listen to Audio');
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            console.log('üîÑ Movie lesson restarted:', currentLesson.title);
        }

        // ‚úÖ FIXED: Return to lessons list helper
        function returnToLessonsList() {
            document.getElementById('lessonInterface').classList.add('hidden');
            document.getElementById('lessonSelection').classList.remove('hidden');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            const currentStudent = getCurrentStudent();
            const displayName = currentStudent ? currentStudent.displayName : 'Estudante';
            document.getElementById('userCourseLine').textContent = `${displayName} ‚Ä¢ Movie Magic`;
        }

        // Logout function
        window.logout = function() {
            localStorage.clear();
            window.location.href = '../index.html';
        };
    </script>

    <!-- Universal Blue/Gray Theme Styles -->
    <style>
        /* Universal Theme Variables */
        :root {
            --foundation-primary: #3b82f6;
            --foundation-secondary: #1d4ed8;
            --foundation-light: #93c5fd;
            --foundation-dark: #1e40af;
            
            --primary-blue: #3b82f6;
            --secondary-blue: #1e40af;
            --accent-red: #ef4444;
            --success-green: #10b981;
            --error-red: #f87171;
            --warning-orange: #f59e0b;
            
            --charcoal: #1f2937;
            --medium-gray: #6b7280;
            --light-gray: #e5e7eb;
            --soft-border: #d1d5db;
            
            --bg-primary: #f8fafc;
            --bg-secondary: #e2e8f0;
            --bg-card: #ffffff;
            --bg-accent: #dbeafe;
        }

        /* Clean Background - Light Gray for Desktop */
        .colorful-bg {
            background: #f1f5f9;
            min-height: 100vh;
        }

        /* Mobile can keep subtle gradient */
        @media (max-width: 768px) {
            .colorful-bg {
                background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
                background-attachment: fixed;
            }
        }

        /* Colorful Main Card */
        .colorful-main-card {
            background: linear-gradient(135deg, var(--foundation-primary), var(--foundation-secondary));
            border: none;
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
            color: white;
        }

        .colorful-accent-card {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        /* Colorful Header Bar */
        .colorful-header-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            background: linear-gradient(135deg, var(--foundation-primary), var(--foundation-secondary));
            border-bottom: 2px solid var(--foundation-dark);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            padding: 16px 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .colorful-header-bar .brand-line {
            font-size: 12px;
            font-weight: 600;
            color: white;
            text-align: center;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .colorful-header-bar .user-course-line {
            font-size: 14px;
            color: #e2e8f0;
            font-weight: 500;
            text-align: center;
        }

        .colorful-header-bar .btn-portal {
            background: rgba(255, 255, 255, 0.9);
            color: var(--foundation-secondary);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .colorful-header-bar .btn-portal:hover {
            background: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .colorful-header-bar .btn-sair {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .colorful-header-bar .btn-sair:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Card Styles */
        .professional-card {
            background: var(--bg-card);
            border: 2px solid var(--bg-accent);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
            transition: all 0.3s ease;
        }

        .professional-card:hover {
            box-shadow: 0 12px 35px rgba(59, 130, 246, 0.25);
            transform: translateY(-3px);
            border-color: var(--foundation-primary);
        }

        .status-card {
            background: linear-gradient(135deg, var(--bg-accent), var(--bg-secondary));
            border: 2px solid var(--foundation-light);
            color: var(--foundation-dark);
        }

        .progress-card {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-accent));
            border: 2px solid var(--foundation-light);
        }

        .audio-card {
            background: var(--bg-card);
            border: 2px solid var(--foundation-light);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.15);
        }

        .question-card {
            background: var(--bg-card);
            border: 2px solid var(--bg-accent);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.1);
        }

        .submit-card {
            background: linear-gradient(135deg, var(--bg-accent), var(--foundation-light));
            border: 2px solid var(--foundation-primary);
        }

        .modal-card {
            background: var(--bg-card);
            border: 2px solid var(--foundation-primary);
            box-shadow: 0 25px 50px rgba(59, 130, 246, 0.25);
        }

        .score-card {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-accent));
            border: 2px solid var(--foundation-primary);
        }

        .achievement-card {
            background: linear-gradient(135deg, var(--foundation-light), var(--bg-accent));
            border: 2px solid var(--foundation-primary);
        }

        /* Enhanced Colors */
        .text-primary-blue { color: var(--primary-blue); }
        .text-accent-red { color: var(--accent-red); }
        .text-success-green { color: var(--success-green); }
        .text-error-red { color: var(--error-red); }
        .text-foundation-primary { color: var(--foundation-primary); }

        /* Progress Bar */
        .progress-bar-container {
            background: var(--bg-secondary);
            overflow: hidden;
            border: 1px solid var(--foundation-light);
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--foundation-primary), var(--foundation-light));
            transition: width 0.8s ease;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        /* Answer Options - MUCH MORE VISIBLE SELECTION */
        .answer-option {
            background: var(--bg-secondary);
            border: 2px solid var(--foundation-light);
            padding: 1rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .answer-option:hover {
            border-color: var(--foundation-primary);
            background: var(--bg-accent);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .answer-option.selected {
            border-color: var(--foundation-primary);
            background: var(--foundation-primary) !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
            transform: translateY(-1px);
        }

        /* Selected Answer Text - WHITE for contrast */
        .answer-option.selected {
            color: white !important;
        }

        .answer-option.selected .option-letter {
            background: white;
            color: var(--foundation-primary);
            border: 2px solid white;
        }

        .answer-option.selected div {
            color: white !important;
        }

        .option-letter {
            background: var(--foundation-primary);
            color: white;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        /* Status Badges */
        .status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid;
        }

        .status-completed {
            background: var(--foundation-primary);
            color: white;
            border-color: var(--foundation-secondary);
        }

        .status-in-progress {
            background: var(--primary-blue);
            color: white;
            border-color: var(--secondary-blue);
        }

        .status-not-started {
            background: var(--bg-accent);
            color: var(--foundation-dark);
            border-color: var(--foundation-light);
        }

        /* Enhanced Buttons */
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-red), #dc2626);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--foundation-primary), var(--foundation-secondary));
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, var(--foundation-secondary), var(--foundation-dark));
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .btn-subtle {
            background: var(--bg-accent);
            color: var(--foundation-dark);
            border: 2px solid var(--foundation-light);
            transition: all 0.3s ease;
        }

        .btn-subtle:hover {
            background: var(--foundation-light);
            border-color: var(--foundation-primary);
            transform: translateY(-1px);
        }

        /* Speed Controls */
        .speed-btn {
            background: var(--bg-accent);
            color: var(--foundation-dark);
            border: 2px solid var(--foundation-light);
            transition: all 0.3s ease;
        }

        .speed-btn:hover,
        .speed-btn.active {
            background: var(--foundation-primary);
            color: white;
            border-color: var(--foundation-secondary);
            transform: translateY(-1px);
        }

        /* Add top margin to main content */
        .lesson-content {
            margin-top: 120px;
        }

        /* Desktop responsive */
        @media (min-width: 768px) {
            .colorful-header-bar {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                padding: 12px 40px;
            }
            
            .header-left {
                text-align: left;
            }
            
            .lesson-content {
                margin-top: 80px;
            }
        }

        /* Mobile adjustments */
        @media (max-width: 480px) {
            .colorful-header-bar {
                padding: 12px 16px;
                gap: 6px;
            }
            
            .colorful-header-bar .brand-line {
                font-size: 11px;
            }
            
            .colorful-header-bar .user-course-line {
                font-size: 13px;
            }
            
            .colorful-header-bar .btn-portal, 
            .colorful-header-bar .btn-sair {
                padding: 6px 12px;
                font-size: 11px;
            }
            
            .lesson-content {
                margin-top: 110px;
            }
        }

        /* Link Styles */
        .link-sophisticated {
            color: var(--foundation-primary);
            transition: color 0.2s ease;
        }
        
        .link-sophisticated:hover {
            color: var(--foundation-secondary);
        }
        
        .link-muted {
            color: var(--medium-gray);
            transition: color 0.2s ease;
        }
        
        .link-muted:hover {
            color: var(--charcoal);
        }

        .bg-primary-blue { background-color: var(--primary-blue); }
        .bg-accent-red { background-color: var(--accent-red); }
        .bg-foundation-primary { background-color: var(--foundation-primary); }
        .text-blue-100 { color: #dbeafe; }
        .text-charcoal { color: var(--charcoal); }
        .text-medium-gray { color: var(--medium-gray); }
        .border-soft-border { border-color: var(--soft-border); }
    </style>

</body>
</html>
